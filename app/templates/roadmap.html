{% extends "base.html" %}
{% block content %}
<div class="dashboard-layout">
    {% include 'dashboard_sidebar.html' %}
    <main class="dashboard-content">
        <div class="page-header">
            <div>
                <h2>Roadmap: {{ current_user.career_path|replace('-', ' ')|title }}</h2>
                <p class="subtitle">Ikuti alur belajar ini untuk menguasai skill yang dibutuhkan.</p>
            </div>
            {% if show_generate_button %}
            <form action="{{ url_for('routes.generate_roadmap') }}" method="POST">
                <button type="submit" class="button-primary">Lengkapi Roadmap dengan AI âœ¨</button>
            </form>
            {% endif %}
        </div>

        <h4 id="progress-text">Progres Keseluruhan: {{ progress }}%</h4>
        <div class="progress-bar" style="margin-bottom: 30px;">
            <div class="progress-bar-inner" style="width: {{ progress }}%;"></div>
        </div>

        <div class="module-accordion">
            {% for module in modules %}
            <details class="module-item card" {% if loop.first %}open{% endif %}>
                <summary>
                    <div class="summary-title">
                        <span class="module-order">Bagian {{ module.order }}</span>
                        {{ module.title }}
                    </div>
                </summary>
                <ul class="lesson-list">
                    {% for lesson in module.lessons %}
                    <ul class="lesson-list">
                        {% for lesson in module.lessons %}
                        <li class="lesson-item">
                            <div class="lesson-top">
                                <input type="checkbox" id="lesson-{{ lesson.id }}" data-lesson-id="{{ lesson.id }}" 
                                       {% if lesson.id in completed_lesson_ids %}checked{% endif %}>
                                <label for="lesson-{{ lesson.id }}" class="lesson-label">
                                    <div class="lesson-info">
                                        <strong>{{ lesson.title }}</strong>
                                        <span>Estimasi: {{ lesson.estimated_time or '30' }} menit</span>
                                    </div>
                                </label>
                            </div>
                    
                            <div class="lesson-bottom">
                                <form action="{{ url_for('routes.new_chat_for_lesson', lesson_id=lesson.id) }}" method="POST">
                                    <button type="submit" class="button-secondary ask-ai-btn">Tanya AI</button>
                                </form>
                                <a href="{{ lesson.url or '#' }}" target="_blank" class="learn-link button-primary">Mulai Belajar</a>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endfor %}
                </ul>
            </details>
            {% endfor %}
        </div>
    </main>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const lessonCheckboxes = document.querySelectorAll('.lesson-list input[type="checkbox"]');
        const progressBar = document.querySelector('.progress-bar-inner');
        const progressText = document.getElementById('progress-text');
    
        const updateProgressBar = () => {
            const totalLessons = lessonCheckboxes.length;
            if (totalLessons === 0) return;
            const completedLessons = document.querySelectorAll('.lesson-list input[type="checkbox"]:checked').length;
            const percentage = Math.round((completedLessons / totalLessons) * 100);
            
            if (progressBar) progressBar.style.width = `${percentage}%`;
            if (progressText) progressText.textContent = `Progres Keseluruhan: ${percentage}%`;
        };
    
        lessonCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', async (e) => {
                const lessonId = e.target.data.lessonId;
                const endpoint = e.target.checked ? `/complete-lesson/${lessonId}` : `/uncomplete-lesson/${lessonId}`;
                
                try {
                    const response = await fetch(endpoint, { method: 'POST' });
                    if (!response.ok) {
                        e.target.checked = !e.target.checked; // Batalkan aksi jika server error
                    }
                } catch (error) {
                    e.target.checked = !e.target.checked; // Batalkan aksi jika ada error jaringan
                } finally {
                    updateProgressBar(); // Selalu update UI
                }
            });
        });
    
        updateProgressBar(); // Panggil saat halaman dimuat
    });
    </script>
{% endblock %}


