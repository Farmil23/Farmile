{% extends 'admin/master.html' %}
{% block body %}
  <style>
    .card-metric {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: .25rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        text-align: center;
    }
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #007bff;
    }
    .metric-label {
        font-size: 1rem;
        color: #6c757d;
    }
    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }
  </style>
  
  <h1>Dashboard Analitik Farmile</h1>
  <p class="lead">Ringkasan aktivitas pengguna, pembelajaran, dan persiapan karier di platform.</p>

  <hr>
  <h3>Statistik Persiapan Karier</h3>
  <div class="row">
    <div class="col-md-3">
        <div class="card-metric">
            <div class="metric-value">{{ total_resumes_analyzed }}</div>
            <div class="metric-label">Total CV Dianalisis</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card-metric">
            <div class="metric-value">{{ total_jobs_tracked }}</div>
            <div class="metric-label">Total Lamaran Dilacak</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card-metric">
            <div class="metric-value">{{ total_coach_sessions }}</div>
            <div class="metric-label">Sesi AI Coach Aktif</div>
        </div>
    </div>
     <div class="col-md-3">
        <div class="card-metric" style="padding: 1rem;">
            <h4>Distribusi Status Lamaran</h4>
            <div class="chart-container" style="height: 150px;">
                <canvas id="jobStatusChart"></canvas>
            </div>
        </div>
    </div>
  </div>


  <hr>
  <h3>Statistik Pembelajaran & Aktivitas</h3>
  <div class="row" style="margin-top: 2rem;">
    <div class="col-md-8">
        <div class="card-metric" style="text-align: left; padding: 1.5rem;">
            <h4>Aktivitas Pengguna (7 Hari Terakhir)</h4>
            <div class="chart-container">
                <canvas id="dailyActivityChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card-metric" style="text-align: left; padding: 1.5rem;">
            <h4>Distribusi Penggunaan Fitur</h4>
            <div class="chart-container">
                <canvas id="featureUsageChart"></canvas>
            </div>
        </div>
    </div>
  </div>

  <div class="row" style="margin-top: 1rem;">
    <div class="col-md-4">
      <h4>Top 5 Pengguna Paling Aktif</h4>
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Nama Pengguna</th>
            <th>Total Aktivitas</th>
          </tr>
        </thead>
        <tbody>
          {% for user_name, total_activities in top_users %}
          <tr>
            <td>{{ user_name }}</td>
            <td>{{ total_activities }}</td>
          </tr>
          {% else %}
          <tr><td colspan="2" class="text-center">Belum ada data</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="col-md-4">
      <h4>Top 5 Materi Paling Populer</h4>
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Judul Materi</th>
            <th>Jumlah Dilihat</th>
          </tr>
        </thead>
        <tbody>
          {% for lesson_title, view_count in top_lessons %}
          <tr>
            <td>{{ lesson_title }}</td>
            <td>{{ view_count }}</td>
          </tr>
          {% else %}
          <tr><td colspan="2" class="text-center">Belum ada data</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="col-md-4">
        <h4>Top 5 Proyek Paling Populer</h4>
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Judul Proyek</th>
              <th>Jumlah Submission</th>
            </tr>
          </thead>
          <tbody>
            {% for project_title, submission_count in top_projects %}
            <tr>
              <td>{{ project_title }}</td>
              <td>{{ submission_count }}</td>
            </tr>
            {% else %}
            <tr><td colspan="2" class="text-center">Belum ada data</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
  </div>
{% endblock %}

{% block tail %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Data dari backend
        const featureData = JSON.parse('{{ feature_usage_chart_data | safe }}');
        const activityData = JSON.parse('{{ daily_activity_chart_data | safe }}');
        const jobStatusData = JSON.parse('{{ job_status_chart_data | safe }}');

        // Grafik Distribusi Fitur (Doughnut Chart)
        const featureCtx = document.getElementById('featureUsageChart').getContext('2d');
        new Chart(featureCtx, {
            type: 'doughnut',
            data: {
                labels: featureData.labels,
                datasets: [{
                    label: 'Jumlah Penggunaan',
                    data: featureData.data,
                    backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2'],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });

        // Grafik Aktivitas Harian (Line Chart)
        const activityCtx = document.getElementById('dailyActivityChart').getContext('2d');
        new Chart(activityCtx, {
            type: 'line',
            data: {
                labels: activityData.labels,
                datasets: [{
                    label: 'Total Aktivitas per Hari',
                    data: activityData.data,
                    backgroundColor: 'rgba(0, 123, 255, 0.2)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });

        // Grafik Status Lamaran Kerja (Pie Chart)
        const jobStatusCtx = document.getElementById('jobStatusChart').getContext('2d');
        new Chart(jobStatusCtx, {
            type: 'pie',
            data: {
                labels: jobStatusData.labels,
                datasets: [{
                    label: 'Jumlah Lamaran',
                    data: jobStatusData.data,
                    backgroundColor: ['#6f42c1', '#007bff', '#fd7e14', '#28a745', '#dc3545'],
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    });
  </script>
{% endblock %}