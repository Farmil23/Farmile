{% extends "base.html" %}

{% block content %}
<div class="code-editor-container">
    <div class="code-editor-header">
        <h2>{{ coding_session.project.title }}</h2>
        <div class="editor-actions">
            <button id="saveFileBtn" class="button-secondary">Simpan File</button>
            <form id="submitForm" action="{{ url_for('routes.submit_from_editor', session_id=coding_session.id) }}" method="POST">
                <button type="submit" class="button-primary">Ajukan Proyek</button>
            </form>
        </div>
    </div>

    <div class="code-editor-main">
        <div class="file-tree-panel">
            <div class="file-explorer-header">
                <h3>File Explorer</h3>
                <div class="file-explorer-actions">
                    <button id="addFileBtn" title="Tambah File Baru">üìÑ</button>
                    <button id="addFolderBtn" title="Tambah Folder Baru">üìÅ</button>
                </div>
            </div>
            <div id="fileTreeContainer"></div>
        </div>
        <div class="editor-panel">
            <div id="editor-placeholder">Pilih file untuk mulai mengedit...</div>
            <textarea id="codeEditor" style="display: none;"></textarea>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/codemirror.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/codemirror.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/mode/python/python.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/mode/javascript/javascript.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/mode/htmlmixed/htmlmixed.js"></script>
<script>
    $(function () { // jQuery document ready
    
        // --- Inisialisasi Variabel & Editor ---
        const fileData = {{ files_json | safe }};
        const createUrl = "{{ url_for('routes.create_node', session_id=coding_session.id) }}";
        const updateContentUrl = "{{ url_for('routes.update_file_content', file_id=0) }}";
        const renameUrl = "{{ url_for('routes.rename_file', file_id=0) }}";
        const deleteUrl = "{{ url_for('routes.delete_file', file_id=0) }}";
        const moveUrl = "{{ url_for('routes.move_node', file_id=0) }}"; // <-- URL BARU
        let currentFileId = null;
    
        const editorElement = document.getElementById('codeEditor');
        const placeholder = document.getElementById('editor-placeholder');
        let editor = CodeMirror.fromTextArea(editorElement, { lineNumbers: true, mode: "python", theme: "default" });
        editor.getWrapperElement().style.display = 'none';
    
        // --- Inisialisasi jsTree (File Explorer) ---
        $('#fileTreeContainer').jstree({
            'core': {
                'data': fileData,
                'check_callback': function(operation, node, node_parent, node_position, more) {
                    if (operation === "move_node") {
                        if (node_parent.id !== '#' && ( !node_parent.original || !node_parent.original.is_folder)) {
                            return false;
                        }
                    }
                    return true;
                }
            },
            'types': { 'default': { 'icon': 'jstree-folder' }, 'file': { 'icon': 'jstree-file' } },
            'plugins': ['dnd', 'contextmenu', 'wholerow', 'types'],
            'contextmenu': { /* ... (tidak ada perubahan di sini) ... */ }
        })
        .on('select_node.jstree', (e, data) => !data.node.original.is_folder && handleSelectFile(data.node))
        .on('rename_node.jstree', (e, data) => handleRename(data.node, data.text))
        // EVENT LISTENER BARU UNTUK MENANGANI DRAG-AND-DROP
        .on('move_node.jstree', (e, data) => {
            handleMoveNode(data.node.id, data.parent);
        });
    
        // --- Event Listeners untuk Tombol Aksi ---
        $('#addFileBtn').on('click', () => handleCreateNode(false));
        $('#addFolderBtn').on('click', () => handleCreateNode(true));
        $('#saveFileBtn').on('click', handleSaveFile);
    
        // --- Fungsi Logika Aksi ---
    
        function handleSelectFile(node) {
            // ... (tidak ada perubahan di sini)
            currentFileId = node.id;
            editor.setValue(node.original.content || "");
            placeholder.style.display = 'none';
            editor.getWrapperElement().style.display = 'block';
            editor.refresh();
            const ext = node.text.split('.').pop();
            if (ext === 'py') editor.setOption('mode', 'python');
            else if (ext === 'js') editor.setOption('mode', 'javascript');
            else if (ext === 'html') editor.setOption('mode', 'htmlmixed');
            else editor.setOption('mode', 'default');
        }
    
        async function handleSaveFile() {
            // ... (tidak ada perubahan di sini)
            if (!currentFileId) { alert("Pilih file yang ingin disimpan."); return; }
            const content = editor.getValue();
            saveFileBtn.disabled = true;
            saveFileBtn.textContent = 'Menyimpan...';
            try {
                const response = await fetch(updateContentUrl.replace('0', currentFileId), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                });
                const result = await response.json();
                if (response.ok) {
                    $('#fileTreeContainer').jstree(true).get_node(currentFileId).original.content = content;
                    alert('File berhasil disimpan!');
                } else {
                    alert(`Gagal menyimpan: ${result.message}`);
                }
            } catch (error) {
                console.error("Error saving file:", error);
                alert('Terjadi kesalahan jaringan saat menyimpan.');
            } finally {
                saveFileBtn.disabled = false;
                saveFileBtn.textContent = 'Simpan File';
            }
        }
        
        // PERBAIKAN: Logika penentuan folder induk yang lebih akurat dan konsisten
        function handleCreateNode(isFolder) {
            const tree = $('#fileTreeContainer').jstree(true);
            let selectedNode = tree.get_selected(true)[0];
            
            let parentNode;
            if (selectedNode) {
                parentNode = selectedNode.original.is_folder ? selectedNode : tree.get_node(selectedNode.parent);
            } else {
                parentNode = tree.get_node('#');
            }
    
            const newNodeData = { text: isFolder ? 'Folder Baru' : 'file_baru.py', type: isFolder ? 'default' : 'file' };
            tree.create_node(parentNode, newNodeData, 'last', (newNode) => {
                tree.edit(newNode, null, async (node, status) => {
                    if (status && node.text.trim() !== '') {
                        const parentId = node.parent === '#' ? null : node.parent;
                        try {
                             const response = await fetch(createUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ filename: node.text, is_folder: isFolder, parent_id: parentId })
                            });
                            const result = await response.json();
                            if (!response.ok) throw new Error(result.message);
                            location.reload();
                        } catch(err) {
                            alert(`Gagal membuat: ${err.message}`);
                            tree.delete_node(node);
                        }
                    } else {
                        tree.delete_node(node);
                    }
                });
            });
        }
    
        async function handleRename(node, newName) {
            // ... (tidak ada perubahan di sini)
            if (isNaN(parseInt(node.id))) { return; }
            try {
                const response = await fetch(renameUrl.replace('0', node.id), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: newName })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                node.original.text = newName;
            } catch(err) {
                alert(`Gagal mengubah nama: ${err.message}`);
                location.reload();
            }
        }
        
        async function handleDelete(node) {
            // ... (tidak ada perubahan di sini)
            if (confirm(`Anda yakin ingin menghapus "${node.text}"?`)) {
                try {
                    const response = await fetch(deleteUrl.replace('0', node.id), { method: 'POST' });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    $('#fileTreeContainer').jstree(true).delete_node(node);
                } catch(err) {
                    alert(`Gagal menghapus: ${err.message}`);
                }
            }
        }
    
        // FUNGSI BARU UNTUK MENYIMPAN PERUBAHAN DRAG-AND-DROP
        async function handleMoveNode(nodeId, newParentId) {
            try {
                const response = await fetch(moveUrl.replace('0', nodeId), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ parent_id: newParentId })
                });
                const result = await response.json();
                if (!response.ok) {
                    // Jika gagal, tampilkan error dan muat ulang untuk kembali ke state yg benar
                    alert(`Gagal memindahkan: ${result.message}`);
                    location.reload();
                }
                // Jika berhasil, tidak perlu melakukan apa-apa, perubahan sudah ada di UI
            } catch (err) {
                alert('Gagal memindahkan node karena kesalahan jaringan.');
                location.reload();
            }
        }
        
        // Muat file pertama saat halaman dibuka
        const firstFileNode = $('#fileTreeContainer').find('.jstree-leaf[data-id]').first();
        if (firstFileNode.length > 0) {
            $('#fileTreeContainer').jstree(true).select_node(firstFileNode.attr('id'));
        }
    });
    </script>
<style>
/* FONT & BODY */
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

/* LAYOUT UTAMA */
.code-editor-container { display: flex; flex-direction: column; height: 88vh; padding: 15px; background-color: #1e1e1e; color: #d4d4d4; }
.code-editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #333333; }
.code-editor-header h2 { margin: 0; font-size: 18px; }
.editor-actions { display: flex; gap: 10px; }
.code-editor-main { display: flex; flex: 1; min-height: 0; gap: 10px; }

/* PANEL FILE EXPLORER */
.file-tree-panel { width: 250px; background-color: #252526; flex-shrink: 0; display: flex; flex-direction: column; border-radius: 4px; }
.file-explorer-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; text-transform: uppercase; font-size: 11px; font-weight: bold; border-bottom: 1px solid #333333; }
.file-explorer-actions button { background: none; border: none; color: #cccccc; cursor: pointer; font-size: 18px; padding: 2px 4px; border-radius: 3px; }
.file-explorer-actions button:hover { background-color: #37373d; }
#fileTreeContainer { padding: 5px; flex-grow: 1; overflow: auto; }

/* PANEL EDITOR */
.editor-panel { flex: 1; position: relative; border-radius: 4px; overflow: hidden; }
#editor-placeholder { color: #888; text-align: center; padding-top: 50px; font-size: 14px; }

/* STYLING JSTREE ALA VS CODE */
.jstree-default .jstree-anchor { color: #cccccc; }
.jstree-default .jstree-wholerow-hovered { background: #2a2d2e; }
.jstree-default .jstree-wholerow-clicked { background: #094771; }
.jstree-default .jstree-node, .jstree-default .jstree-leaf { background: none; }
.jstree-default .jstree-themeicon-custom { width: auto !important; }
/* Ikon kustom untuk folder dan file */
.jstree-default .jstree-icon.jstree-folder { background: none !important; }
.jstree-default .jstree-icon.jstree-folder::before { content: "üìÅ"; }
.jstree-default .jstree-icon.jstree-file { background: none !important; }
.jstree-default .jstree-icon.jstree-file::before { content: "üìÑ"; }

/* STYLING CODEMIRROR & BUTTON */
.CodeMirror { height: 100%; background-color: #1e1e1e; font-size: 15px; }
.cm-s-default .cm-comment { color: #6a9955; }
.cm-s-default .cm-string { color: #ce9178; }
.cm-s-default .cm-keyword { color: #c586c0; }
.cm-s-default .cm-number { color: #b5cea8; }
.cm-s-default .cm-def { color: #9cdcfe; }
.cm-s-default .cm-variable { color: #9cdcfe; }
.cm-s-default .cm-property { color: #dcdcaa; }
.cm-s-default .cm-operator { color: #d4d4d4; }
.CodeMirror-gutters { background: #1e1e1e !important; border-right: 1px solid #333; }
.CodeMirror-linenumber { color: #858585; }

.button-primary, .button-secondary { font-size: 13px; }
</style>

{% endblock %}