{% extends "base.html" %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot.css') }}">
{% endblock %}

{% block content %}
<div class="chat-page-layout">

    <aside id="history-sidebar" class="chat-history-sidebar">
        <div class="sidebar-header">
            <h4>Riwayat Percakapan</h4>
            <button id="close-sidebar-btn" class="icon-btn">&times;</button>
        </div>
        
        <div style="padding: 1rem 1rem 0 1rem;">
            <form action="{{ url_for('routes.new_chat_session') }}" method="POST">
                <button type="submit" class="button-primary new-chat-btn">ï¼‹ Percakapan Baru</button>
            </form>
        </div>
        
        <nav class="session-list">
            {% for session in all_sessions %}
            <div class="session-item {% if session.id == current_session.id %}active{% endif %}">
                <a href="{{ url_for('routes.chatbot_session', session_id=session.id) }}" class="session-title-link" title="{{ session.title }}">
                    {{ session.title }}
                </a>
                <button class="session-actions-btn" data-session-id="{{ session.id }}" title="Opsi">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="actions-dropdown" id="dropdown-{{ session.id }}">
                    <button class="rename-btn">Ubah Nama</button>
                    <form action="{{ url_for('routes.delete_chat_session', session_id=session.id) }}" method="POST" class="js-confirm-delete" data-confirm-message="Anda yakin ingin menghapus percakapan '{{ session.title }}'?">
                        <button type="submit" class="delete-btn">Hapus</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </nav>
    </aside>

    <main class="chat-page-container">
        <div class="chat-header">
            <div class="chat-header-left">
                <button id="sidebar-toggle-btn" class="icon-btn" title="Tampilkan Riwayat">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <div id="session-title-container">
                    <h4 id="session-title">
                        {% if current_session.project %}
                            Diskusi Proyek: {{ current_session.project.title }}
                        {% else %}
                            {{ current_session.title }}
                        {% endif %}
                    </h4>
                    {% if not current_session.project %}
                        <input type="text" id="session-title-input" class="hidden" value="{{ current_session.title }}">
                    {% endif %}
                </div>
                {% if not current_session.project %}
                <button id="edit-title-btn" class="edit-btn" title="Ubah Nama">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                {% endif %}
            </div>
            <a href="{{ url_for('routes.dashboard') }}" class="button-secondary">Kembali ke Dasbor</a>
        </div>
        
        <div id="chat-window" class="chat-window">
            </div>

        <div class="chat-input-area">
            <textarea id="chat-input" placeholder="Ketik pesan Anda di sini..." rows="1"></textarea>
            <button id="send-chat-btn" class="button-primary" title="Kirim Pesan">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </main>
</div> <div id="sidebar-overlay" class="sidebar-overlay"></div>
{% endblock %}


{% block scripts %}
<script>
    window.CHAT_CONFIG = {
        currentSessionId: {{ current_session.id }},
        userProfilePic: '{{ current_user.profile_pic }}',
        aiAvatarPic: '{{ url_for('static', filename='images/ai-avatar.png') }}',
        renameSessionUrl: "{{ url_for('routes.rename_session', session_id=current_session.id) }}",
        chatApiUrl: "{{ url_for('routes.chat_ai', session_id=current_session.id) }}",
        initialMessages: {{ history | tojson | safe }}
    };
</script>

<script src="{{ url_for('static', filename='js/chatbot.js') }}"></script>
{% endblock %}