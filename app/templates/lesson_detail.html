{% extends "dashboard_base.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/lesson_detail.css') }}">
{% endblock %}

{% block dashboard_content %}

<div class="content-layout" style= "margin: 20px 30px;">
    <div class="page-header">
        <div>
            <a href="{{ url_for('routes.roadmap') }}" class="back-link button-secondary" style= "padding: 0.4rem 0.8rem;">‹ Kembali ke Roadmap</a>
            <h1>{{ lesson.title }}</h1>
            <p class="subtitle">Modul: {{ lesson.module.title }}</p>
        </div>
    </div>

    <div class="card lesson-content">
        <div class="core-content">
            {% if lesson.content %}
                {{ lesson.content | safe }}
            {% else %}
                <h3>Materi Inti</h3>
                <p>Konten untuk materi ini akan segera tersedia.</p>
            {% endif %}
        </div>

        {% if quiz_data and quiz_data.questions %}
        <div class="quiz-container slider-mode">
            <h3>Uji Pemahaman Anda</h3>
            
            <div id="quiz-meta-info" class="quiz-meta-info">
                <span id="quiz-attempt-counter">Percobaan: 1</span>
                <span>•</span>
                <span id="quiz-question-counter">Soal: 1 dari {{ quiz_data.questions|length }}</span>
            </div>
            
            <div class="quiz-progress-container">
                <div id="quiz-progress-bar" class="quiz-progress-bar"></div>
            </div>

            <div class="quiz-slider">
                <div id="quiz-slides-wrapper" class="quiz-slides-wrapper">
                    {# Slide untuk pertanyaan kuis akan dibuat oleh JavaScript #}
                </div>
            </div>

            <div class="quiz-navigation">
                <button id="quiz-prev-btn" class="button-secondary" style="display: none;">Sebelumnya</button>
                <button id="quiz-next-btn" class="button-primary">Selanjutnya</button>
                <button id="quiz-finish-btn" class="button-primary" style="display: none;">Selesaikan Kuis</button>
                <button id="quiz-retry-btn" class="button-secondary" style="display: none;">Coba Lagi</button>
            </div>
            
            <div id="quiz-history-container" style="margin-top: 2rem;">
                {# Riwayat akan dirender di sini oleh JavaScript #}
            </div>
        </div>
        {% endif %}
    </div>

    {# --- BAGIAN YANG DIPERBARUI --- #}
    <div class="lesson-actions">
        <a href="{{ url_for('routes.dashboard') }}" class="button-secondary">Kembali ke Dashboard</a>
        
        <form action="{{ url_for('routes.new_chat_for_lesson', lesson_id=lesson.id) }}" method="POST" style="margin-left: 1rem; margin-right: 1rem;">
            <button type="submit" class="button-secondary ask-ai-btn">Tanya AI</button>
        </form>
        
        {% if not is_completed %}
            <form action="{{ url_for('routes.complete_lesson', lesson_id=lesson.id) }}" method="POST">
                <input type="hidden" name="source" value="detail">
                <button type="submit" class="button-primary">Tandai Sudah Selesai ✔</button>
            </form>
        {% endif %}
    </div>
    {# --- AKHIR BAGIAN YANG DIPERBARUI --- #}
</div>

{% endblock %}

{% block page_scripts %}
<script>
// ... (Seluruh kode JavaScript untuk kuis tetap sama persis) ...
document.addEventListener('DOMContentLoaded', () => {
    const quizContainer = document.querySelector('.quiz-container.slider-mode');
    if (quizContainer) {
        const quizData = {{ quiz_data | tojson | safe }};
        const initialHistory = {{ quiz_history | tojson | safe }};
        const lessonId = {{ lesson.id }};

        const slidesWrapper = document.getElementById('quiz-slides-wrapper');
        const nextBtn = document.getElementById('quiz-next-btn');
        const prevBtn = document.getElementById('quiz-prev-btn');
        const finishBtn = document.getElementById('quiz-finish-btn');
        const retryBtn = document.getElementById('quiz-retry-btn');
        const progressBar = document.getElementById('quiz-progress-bar');
        const attemptCounterEl = document.getElementById('quiz-attempt-counter');
        const questionCounterEl = document.getElementById('quiz-question-counter');
        const historyContainer = document.getElementById('quiz-history-container');
        const metaInfo = document.getElementById('quiz-meta-info');
        const progressContainer = document.querySelector('.quiz-progress-container');
        const quizNavigation = document.querySelector('.quiz-navigation');

        let currentSlide = 0;
        let attemptCount = initialHistory.length + 1;
        const totalQuestions = quizData.questions.length;
        let userAnswers = {};
        
        const instantRetries = 2; 
        let countdownInterval;

        const startCooldown = (cooldownEndTime) => {
            clearInterval(countdownInterval); 
            const endTime = new Date(cooldownEndTime).getTime();
            let cooldownMessage = document.getElementById('cooldown-message');
            if (!cooldownMessage) {
                cooldownMessage = document.createElement('p');
                cooldownMessage.id = 'cooldown-message';
                cooldownMessage.className = 'text-secondary';
                cooldownMessage.style.textAlign = 'center';
                cooldownMessage.style.marginTop = '1rem';
                retryBtn.parentElement.appendChild(cooldownMessage);
            }
            cooldownMessage.style.display = 'block';

            const updateTimer = () => {
                const now = new Date().getTime();
                const distance = endTime - now;
                const secondsLeft = Math.ceil(distance / 1000);

                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                    retryBtn.disabled = false;
                    retryBtn.textContent = 'Coba Lagi';
                    cooldownMessage.style.display = 'none';
                } else {
                    retryBtn.disabled = true;
                    retryBtn.textContent = `Coba Lagi (${secondsLeft}s)`;
                    cooldownMessage.innerHTML = `Anda bisa mencoba lagi dalam <strong>${secondsLeft}</strong> detik. Manfaatkan waktu ini untuk me-review materi.`;
                }
            };
            
            updateTimer(); 
            countdownInterval = setInterval(updateTimer, 1000);
        };

        const buildQuizSlides = () => {
            slidesWrapper.innerHTML = '';
            quizData.questions.forEach((question, index) => {
                const slide = document.createElement('div');
                slide.className = 'quiz-slide';
                slide.innerHTML = `
                    <div class="quiz-question-card">
                        <p class="quiz-question-text">${index + 1}. ${question.question_text}</p>
                        <div class="quiz-options">
                            ${question.options.map(option => `
                                <label class="quiz-option">
                                    <input type="radio" name="question-${index + 1}" value="${option}">
                                    <span>${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                slidesWrapper.appendChild(slide);
            });
            slidesWrapper.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', (e) => userAnswers[e.target.name] = e.target.value);
            });
        };
        
        const renderHistory = () => {
            historyContainer.innerHTML = '';
            if (initialHistory.length === 0) return;
            const historyHeader = document.createElement('h4');
            historyHeader.textContent = 'Riwayat Pengerjaan';
            historyContainer.appendChild(historyHeader);
            initialHistory.forEach(attempt => {
                const attemptWrapper = document.createElement('div');
                attemptWrapper.className = 'attempt-result-wrapper';
                attemptWrapper.innerHTML = `
                    <div class="attempt-header">
                        <h4>Hasil Percobaan ${attempt.attempt_number} (Nilai: ${attempt.score})</h4>
                        <button class="button-secondary view-details-btn">Lihat Detail</button>
                    </div>
                    <div class="summary-content" style="display: none;"></div>
                `;
                const summaryContent = attemptWrapper.querySelector('.summary-content');
                quizData.questions.forEach((question, index) => {
                    const userAnswer = attempt.answers_data[`question-${index+1}`] || "Tidak dijawab";
                    const isCorrect = userAnswer === question.correct_answer;
                    const summaryItem = document.createElement('div');
                    summaryItem.className = `summary-item ${isCorrect ? 'correct' : 'incorrect'}`;
                    summaryItem.innerHTML = `
                        <p><strong>Soal ${index + 1}:</strong> ${question.question_text}</p>
                        <p>Jawaban Anda: ${userAnswer}</p>
                        ${!isCorrect ? `<p>Jawaban Benar: ${question.correct_answer}</p>` : ''}
                        <p><em>Penjelasan: ${question.explanation}</em></p>`;
                    summaryContent.appendChild(summaryItem);
                });
                historyContainer.appendChild(attemptWrapper);
            });
            historyContainer.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const content = e.currentTarget.parentElement.nextElementSibling;
                    const isVisible = content.style.display === 'block';
                    content.style.display = isVisible ? 'none' : 'block';
                    e.currentTarget.textContent = isVisible ? 'Lihat Detail' : 'Sembunyikan Detail';
                });
            });
        };

        const updateUIForActiveQuiz = () => {
            slidesWrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
            const progress = totalQuestions > 1 ? (currentSlide / (totalQuestions - 1)) * 100 : (currentSlide === 0 ? 0 : 100);
            progressBar.style.width = `${progress}%`;
            questionCounterEl.textContent = `Soal: ${currentSlide + 1} dari ${totalQuestions}`;
            attemptCounterEl.textContent = `Percobaan: ${attemptCount}`;
            prevBtn.style.display = currentSlide > 0 ? 'inline-flex' : 'none';
            nextBtn.style.display = currentSlide < totalQuestions - 1 ? 'inline-flex' : 'none';
            finishBtn.style.display = currentSlide === totalQuestions - 1 ? 'inline-flex' : 'none';
            retryBtn.style.display = 'none';
        };

        const checkAnswersAndSave = async () => {
            finishBtn.disabled = true;
            finishBtn.textContent = 'Menyimpan...';
            let correctAnswers = 0;
            quizData.questions.forEach((question, index) => {
                if (userAnswers[`question-${index + 1}`] === question.correct_answer) {
                    correctAnswers++;
                }
            });
            const finalScore = Math.round((correctAnswers / totalQuestions) * 100);
            try {
                const response = await fetch(`/api/lesson/${lessonId}/quiz/save_attempt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        score: finalScore,
                        attempt_number: attemptCount,
                        answers_data: userAnswers
                    })
                });
                if (!response.ok) throw new Error('Gagal menyimpan hasil.');
                window.location.reload();
            } catch (error) {
                alert(error.message);
                finishBtn.disabled = false;
                finishBtn.textContent = 'Selesaikan Kuis';
            }
        };

        const resetQuizForNewAttempt = () => {
            clearInterval(countdownInterval);
            currentSlide = 0;
            userAnswers = {};
            attemptCount++;
            historyContainer.style.display = 'block';
            slidesWrapper.style.display = 'flex';
            metaInfo.style.display = 'block';
            progressContainer.style.display = 'block';
            
            let cooldownMessage = document.getElementById('cooldown-message');
            if (cooldownMessage) cooldownMessage.style.display = 'none';
            
            buildQuizSlides();
            updateUIForActiveQuiz();
        };
        
        buildQuizSlides();
        renderHistory();

        if (initialHistory.length > 0) {
            slidesWrapper.style.display = 'none';
            metaInfo.style.display = 'none';
            progressContainer.style.display = 'none';
            quizNavigation.style.display = 'flex';
            
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
            finishBtn.style.display = 'none';
            retryBtn.style.display = 'inline-flex';
            retryBtn.addEventListener('click', resetQuizForNewAttempt);
            
            const lastAttempt = initialHistory[initialHistory.length - 1];
            if (lastAttempt && lastAttempt.cooldown_until) {
                const now = new Date().getTime();
                const endTime = new Date(lastAttempt.cooldown_until).getTime();
                if (now < endTime) {
                    startCooldown(lastAttempt.cooldown_until);
                }
            }
        } else {
            updateUIForActiveQuiz();
        }

        // --- SCRIPT BARU UNTUK MEMBUNGKUS TABEL SECARA OTOMATIS ---
        const contentArea = document.querySelector('.core-content');
        if (contentArea) {
            const tables = contentArea.querySelectorAll('table');
            tables.forEach(table => {
                // Cek apakah tabel belum dibungkus
                if (!table.parentElement.classList.contains('table-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-wrapper';
                    // Pindahkan tabel ke dalam wrapper
                    table.parentNode.insertBefore(wrapper, table);
                    wrapper.appendChild(table);
                }
            });
        }

        nextBtn.addEventListener('click', () => {
            if (currentSlide < totalQuestions - 1) currentSlide++;
            updateUIForActiveQuiz();
        });
        prevBtn.addEventListener('click', () => {
            if (currentSlide > 0) currentSlide--;
            updateUIForActiveQuiz();
        });
        finishBtn.addEventListener('click', checkAnswersAndSave);
    }
});
</script>
{% endblock %}