{% extends "dashboard_base.html" %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/my_projects.css') }}">
{% endblock %}

{% block dashboard_content %}
    <div class="page-header">
        <div>
            <h2>Proyek Saya</h2>
            <p class="subtitle">Kelola semua proyek yang sedang Anda kerjakan dan yang sudah selesai.</p>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('routes.challenge_projects') }}" class="button-secondary">Ambil Challenge Project üèÜ</a>
            <a href="{{ url_for('routes.select_project') }}" class="button-primary">Ambil Project dari Roadmap</a>
        </div>
    </div>

    {% if grouped_projects %}
        {% for category_name, projects_in_category in grouped_projects.items() %}
        <div class="project-category-section">
            <h3 class="category-title">{{ category_name }}</h3>
            <div class="projects-grid">
                {% for data in projects_in_category %}
                {# --- KARTU PROYEK YANG DISEDERHANAKAN --- #}
                <div class="card project-card-simplified" 
                     role="button" 
                     tabindex="0"
                     data-project='{{ {
                         "title": data.user_project.project.title,
                         "description": data.user_project.project.description or 'Proyek ini menantang Anda untuk menerapkan konsep yang telah dipelajari.',
                         "module_title": data.module_title,
                         "status": "completed" if (data.submission and data.submission.interview_score) else "pending" if data.submission else "in-progress",
                         "score": data.submission.interview_score if data.submission else none,
                         "submission_id": data.submission.id if data.submission else none,
                         "user_project_id": data.user_project.id,
                         "project_id": data.user_project.project.id
                     } | tojson }}'>
                    
                    <div class="project-card-header">
                        <h4>{{ data.user_project.project.title }}</h4>
                        {% if data.submission and data.submission.interview_score %}
                            <span class="status-badge completed">Selesai</span>
                        {% elif data.submission %}
                            <span class="status-badge pending">Wawancara</span>
                        {% else %}
                            <span class="status-badge in-progress">Dikerjakan</span>
                        {% endif %}
                    </div>
                    <div class="project-module-info">
                        <small><strong>Modul:</strong> {{ data.module_title }}</small>
                    </div>
                    {% if data.submission and data.submission.interview_score %}
                        <p class="score-summary">Skor Akhir: <span class="skor-badge">{{ data.submission.interview_score }}</span></p>
                    {% else %}
                        <p class="description-summary">{{ data.user_project.project.description | truncate(100) }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="card empty-state">
            <h3>Belum Ada Proyek Aktif</h3>
            <p>Mulai perjalanan Anda dengan mengambil proyek dari roadmap.</p>
            <a href="{{ url_for('routes.select_project') }}" class="button-primary" style="margin-top: 1rem;">Pilih Proyek Pertama</a>
        </div>
    {% endif %}
{% endblock %}


{% block page_scripts %}
{# --- MODAL PREMIUM UNTUK DETAIL PROYEK --- #}
<div id="projectDetailModal" class="modal-overlay">
    <div class="modal-box card">
        <div class="modal-header">
            <h3 id="modalProjectTitle">Judul Proyek</h3>
            <button class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div id="modalProjectModule" class="project-module-info"></div>
            <p id="modalProjectDescription"></p>
        </div>
        <div class="modal-footer">
            <div id="modalProjectActions" class="modal-actions-container">
                </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const detailModal = document.getElementById('projectDetailModal');
    if (detailModal) {
        const modalTitle = document.getElementById('modalProjectTitle');
        const modalModule = document.getElementById('modalProjectModule');
        const modalDescription = document.getElementById('modalProjectDescription');
        const modalActions = document.getElementById('modalProjectActions');

        document.querySelectorAll('.project-card-simplified').forEach(card => {
            card.addEventListener('click', () => {
                const projectData = JSON.parse(card.dataset.project);
                
                modalTitle.textContent = projectData.title;
                modalModule.innerHTML = `<small><strong>Dari Modul:</strong> ${projectData.module_title}</small>`;
                modalDescription.textContent = projectData.description;
                modalActions.innerHTML = generateActionButtons(projectData);
                
                detailModal.classList.add('visible');
            });
        });

        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal || e.target.closest('.modal-close-btn')) {
                detailModal.classList.remove('visible');
            }
        });
    }

    function generateActionButtons(data) {
        const actions = {
            lanjutkan: `<a href="/project/${data.project_id}" class="button-primary">Lanjutkan Mengerjakan</a>`,
            batalkan: `<form action="/cancel-project/${data.user_project_id}" method="POST" class="js-confirm-delete" data-confirm-message="Yakin membatalkan proyek ini?"><button type="submit" class="button-danger">Batalkan</button></form>`,
            mulaiWawancara: `<a href="/interview/${data.submission_id}" class="button-primary">Mulai Wawancara</a>`,
            editLink: `<a href="/edit-submission/${data.submission_id}" class="button-secondary" style= " margin:0">Edit Link</a>`,
            hapusSubmission: `<form action="/cancel-submission/${data.submission_id}" method="POST" class="js-confirm-delete" data-confirm-message="Yakin membatalkan submission?"><button type="submit" class="button-danger">Hapus</button></form>`,
            lihatPortfolio: `<a href="/submission/${data.submission_id}/portfolio" class="button-primary" target="_blank">Lihat Portofolio</a>`,
            ulangiWawancara: `<form action="/submission/${data.submission_id}/retry-interview" method="POST" class="js-confirm-delete" data-confirm-message="Yakin reset wawancara?"><button type="submit" class="button-secondary">Ulangi Wawancara</button></form>`,
            lihatRiwayat: `<a href="/interview/${data.submission_id}" class="button-secondary">Lihat Riwayat</a>`
        };

        const disabledActions = {
            mulaiWawancara: `<button class="button-text" disabled>Mulai Wawancara</button>`,
            lihatPortfolio: `<button class="button-text" disabled>Lihat Portofolio</button>`
        };

        if (data.status === 'in-progress') {
            return `${actions.lanjutkan} ${actions.batalkan} ${disabledActions.mulaiWawancara} ${disabledActions.lihatPortfolio}`;
        } else if (data.status === 'pending') {
            return `${actions.mulaiWawancara} ${actions.editLink} ${actions.hapusSubmission} ${disabledActions.lihatPortfolio}`;
        } else if (data.status === 'completed') {
            return `${actions.lihatPortfolio} ${actions.ulangiWawancara} ${actions.lihatRiwayat}`;
        }
        return '';
    }
});
</script>
{% endblock %}