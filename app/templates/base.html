<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title|default('FARSIGHT') }} - FARSIGHT</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />

    {% block styles %}{% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        svg: {
          fontCache: 'global'
        }
      };
    </script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>
  </head>
  <body data-theme="dark" style="margin:0; width: 100%;">
    <header>
      <a href="{{ url_for('routes.dashboard') }}" class="header-link"
        >FARSIGHT</a
      >

      <nav class="main-app-nav">
        <div class="desktop-only-nav">
            <a
              href="{{ url_for('routes.dashboard') }}"
              class="{{ 'active' if request.endpoint == 'routes.dashboard' else '' }}"
              >DASHBOARD</a
            >
            <a
              href="{{ url_for('routes.roadmap') }}"
              class="{{ 'active' if request.endpoint == 'routes.roadmap' else '' }}"
              >ROADMAP</a
            >
            <a
              href="{{ url_for('routes.personal_hub') }}"
              class="{{ 'active' if request.endpoint == 'routes.personal_hub' else '' }}"
              >PERSONAL HUB</a
            >
        </div>

        {% if current_user.is_authenticated %}
        <div class="notification-wrapper">
          <a
            id="notification-bell"
            class="notification-bell-link"
            title="Notifikasi"
          >
            <i class="fas fa-bell"></i>
            <span id="notification-indicator"></span>
          </a>
          <div id="notification-panel" class="notification-panel">
            <div class="notification-panel-header">Notifikasi</div>
            <ul id="notification-list">
              <li class="notification-item-empty">Memuat...</li>
            </ul>
            <div class="notification-panel-footer">
              <div class="notification-panel-footer">
                <a href="{{ url_for('routes.notifications_page') }}"
                  >Lihat Semua Notifikasi</a
                >
              </div>
            </div>
          </div>
        </div>

        <a
          href="{{ url_for('routes.profile') }}"
          class="profile-link"
          title="Pengaturan & Profil"
        >
          <img src="{{ current_user.profile_pic }}" alt="Profil" />
        </a>
        {% endif %}
      </nav>
    </header>

    <main>{% block content %}{% endblock %}</main>

    <div id="confirmModal" class="modal-overlay">
      <div class="modal-box card">
        <h3 id="modalTitle">Konfirmasi Tindakan</h3>
        <p id="modalMessage" class="text-secondary">Apakah Anda yakin?</p>
        <div class="modal-actions">
          <button id="modalCancelBtn" class="button-secondary">Batal</button>
          <button id="modalConfirmBtn" class="button-danger">
            Ya, Lanjutkan
          </button>
        </div>
      </div>
    </div>
    
    <div id="toast-notification" class="toast">
        <div id="toast-message" class="toast-message"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const confirmModal = document.getElementById("confirmModal");
            
            if (confirmModal) {
                const modalTitle = document.getElementById("modalTitle");
                const modalMessage = document.getElementById("modalMessage");
                const modalConfirmBtn = document.getElementById("modalConfirmBtn");
                const modalCancelBtn = document.getElementById("modalCancelBtn");
        
                const showConfirmModal = (title, message) => {
                    return new Promise((resolve) => {
                        modalTitle.textContent = title;
                        modalMessage.textContent = message;
                        confirmModal.classList.add("visible");
        
                        const confirmHandler = () => {
                            confirmModal.classList.remove("visible");
                            resolve(true);
                        };
                        
                        const cancelHandler = () => {
                            confirmModal.classList.remove("visible");
                            resolve(false);
                        };
        
                        modalConfirmBtn.onclick = confirmHandler;
                        modalCancelBtn.onclick = cancelHandler;
                        
                        confirmModal.onclick = (e) => {
                            if (e.target === confirmModal) cancelHandler();
                        };
                    });
                };
        
                document.body.addEventListener('submit', async (e) => {
                    if (e.target.matches('.js-confirm-delete')) {
                        e.preventDefault(); 
                        
                        const message = e.target.dataset.confirmMessage || "Tindakan ini tidak bisa dibatalkan. Anda yakin?";
                        const title = e.target.dataset.confirmTitle || "Konfirmasi Hapus";
        
                        const isConfirmed = await showConfirmModal(title, message);
        
                        if (isConfirmed) {
                            e.target.submit();
                        }
                    }
                });
            }
        });
    </script>
        
    {% block scripts %}{% endblock %}
    
    {% if current_user.is_authenticated %}
    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
    {% endif %}

    {# --- BLOK BARU DAN TERPISAH UNTUK SKRIP HALAMAN TURUNAN --- #}
    {% block page_scripts %}{% endblock %}

    {# --- SCRIPT UNTUK MENAMPILKAN TOAST DARI FLASH MESSAGE --- #}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            let toastTimeout;

            function showToast(message, type = 'success') {
                if (!toast || !toastMessage) return;
                
                clearTimeout(toastTimeout);
                toastMessage.textContent = message;
                toast.className = 'toast';
                toast.classList.add(type);
                
                toast.classList.add('show');
                
                toastTimeout = setTimeout(() => {
                    toast.classList.remove('show');
                }, 4000);
            }

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        showToast("{{ message }}", "{{ category }}");
                    {% endfor %}
                {% endif %}
            {% endwith %}
        });
    </script>

  </body>
</html>