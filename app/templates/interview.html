{% extends "base.html" %}
{% block content %}
<div class="interview-layout">
    <aside class="interview-sidebar card">
        <h3>Proyek yang Diwawancara</h3>
        <hr>
        <h4>{{ submission.project.title }}</h4>
        <p class="text-secondary">{{ submission.project.description }}</p>
        
        <h5>Link Submission Anda:</h5>
        <a href="{{ submission.project_link }}" target="_blank" rel="noopener noreferrer">{{ submission.project_link }}</a>
        <hr>
        <a href="{{ url_for('routes.my_projects') }}" class="button-secondary">Selesai Wawancara</a>
    </aside>

    <main class="interview-chat">
        <div id="chat-history" class="chat-history">
            <div class="chat-message assistant">
                <div class="message-bubble">
                    <p>Halo, saya siap untuk memulai wawancara teknis mengenai proyek Anda. Silakan ceritakan secara singkat tentang proyek yang Anda buat dan teknologi apa yang Anda gunakan.</p>
                </div>
            </div>
            {% for message in messages %}
            <div class="chat-message {{ message.role }}">
                <div class="message-bubble">
                    <p>{{ message.content | safe }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="chat-input-area">
            <form id="interview-form">
                <textarea id="message-input" name="message" placeholder="Ketik pesanmu di sini..." required></textarea>
                <button type="submit" id="send-button" title="Kirim Pesan">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </form>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('interview-form');
        const input = document.getElementById('message-input');
        const history = document.getElementById('chat-history');
        const sendButton = document.getElementById('send-button');
        const submissionId = {{ submission.id }};
    
        // Fungsi untuk auto-resize textarea
        const adjustTextareaHeight = () => {
            input.style.height = 'auto'; // Reset tinggi
            input.style.height = (input.scrollHeight) + 'px'; // Atur tinggi sesuai konten
        };
    
        input.addEventListener('input', adjustTextareaHeight); // Panggil saat mengetik
    
        // Fungsi untuk mengirim pesan
        const sendMessage = async () => {
            const message = input.value.trim();
            if (!message) return;
    
            addMessageToHistory('user', message);
            input.value = '';
            adjustTextareaHeight(); // Reset tinggi setelah kirim
            input.disabled = true;
            sendButton.disabled = true;
            sendButton.textContent = 'Menunggu...';
    
            try {
                const response = await fetch(`/interview-ai/${submissionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                if (!response.ok) throw new Error('Gagal mendapatkan balasan.');
    
                const data = await response.json();
                addMessageToHistory('assistant', data.response);
    
            } catch (error) {
                addMessageToHistory('assistant', 'Maaf, terjadi kesalahan. Silakan coba lagi.');
            } finally {
                input.disabled = false;
                sendButton.disabled = false;
                sendButton.textContent = 'Kirim';
                input.focus();
            }
        };
    
        // Event listener untuk form
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage();
        });
    
        // Event listener untuk keyboard (Enter to Send)
        input.addEventListener('keydown', (e) => {
            // Jika Enter ditekan TANPA Shift, kirim pesan
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Mencegah baris baru
                sendMessage();
            }
            // Jika Shift + Enter, pengguna bisa membuat baris baru (default behavior)
        });
    
        const addMessageToHistory = (role, content) => {
            // ... (fungsi addMessageToHistory tetap sama seperti sebelumnya)
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            const p = document.createElement('p');
            p.textContent = content;
            bubbleDiv.appendChild(p);
            messageDiv.appendChild(bubbleDiv);
            history.appendChild(messageDiv);
            history.scrollTop = history.scrollHeight;
        };
        
        // Panggil sekali saat load untuk set tinggi awal
        adjustTextareaHeight();
    });
    </script>
{% endblock %}