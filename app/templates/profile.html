{% extends "settings_base.html" %}
{% block settings_content %}

    <div class="profile-header">
        <div class="profile-cover">
            <div class="cover-gradient"></div>
        </div>
        <div class="profile-info">
            <div class="profile-avatar-section">
                <img src="{{ user.profile_pic }}" alt="Foto Profil" class="profile-avatar">
                <div class="profile-status">
                    <span class="status-indicator online"></span>
                    <span class="status-text">Online</span>
                </div>
            </div>
            <div class="profile-details">
                <h1 class="profile-name">{{ user.name }}</h1>
                <p class="profile-email">{{ user.email }}</p>
                <div class="profile-badges">
                    <span class="career-badge">{{ user.career_path|replace('-', ' ')|title if user.career_path else 'Explorer' }}</span>
                    <span class="semester-badge">Semester {{ user.semester if user.semester else 'N/A' }}</span>
                    <span class="level-badge">Level {{ user.level }}</span>
                </div>
                <div class="profile-actions">
                    <a href="{{ url_for('routes.edit_profile') }}" class="button-primary">Edit Profil</a>
                    <button class="button-secondary share-profile">Bagikan Profil</button>
                </div>
            </div>
        </div>
    </div>

    <div class="profile-stats">
        <div class="stat-item">
            <div class="stat-number">{{ user.user_progress.count() }}</div>
            <div class="stat-label">Materi Diselesaikan</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ user.submissions.count() }}</div>
            <div class="stat-label">Proyek Disubmit</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ user.chat_sessions.count() }}</div>
            <div class="stat-label">Sesi Chat AI</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ user.xp }}</div>
            <div class="stat-label">Total XP</div>
        </div>
    </div>

    <div class="profile-content">
        <div class="profile-section">
            <div class="section-header">
                <h3>Tentang Saya</h3>
            </div>
            <div class="about-content">
                <p class="about-text">
                    {% if user.career_path %}
                        Saya adalah mahasiswa semester {{ user.semester }} yang sedang menekuni jalur {{ user.career_path|replace('-', ' ')|title }}. 
                        Saya sangat antusias untuk mengembangkan skill teknologi dan membangun karier di bidang yang saya minati.
                    {% else %}
                        Saya adalah mahasiswa yang sedang mengeksplorasi berbagai bidang teknologi untuk menemukan passion dan jalur karier yang tepat.
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="profile-section">
            <div class="section-header">
                <h3>Proyek Terbaru</h3>
                <a href="{{ url_for('routes.my_projects') }}" class="view-all-link">Lihat Semua</a>
            </div>
            <div class="projects-grid">
                {% for submission in recent_submissions %}
                <div class="project-card">
                    <div class="project-header">
                        <h4 class="project-title">{{ submission.project.title }}</h4>
                        <span class="project-status {{ 'approved' if submission.interview_score else 'pending' }}">{{ 'Selesai' if submission.interview_score else 'Menunggu Wawancara' }}</span>
                    </div>
                    <p class="project-description">{{ submission.project.description[:100] }}...</p>
                </div>
                {% else %}
                <div class="empty-state">
                    <h4>Belum ada proyek</h4>
                    <p>Mulai kerjakan proyek pertama Anda dari roadmap!</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="profile-section">
            <div class="section-header">
                <h3>Aktivitas Terbaru</h3>
            </div>
            <div class="activity-timeline">
                {% if recent_sessions or recent_progress %}
                    {% for session in recent_sessions %}
                    <div class="timeline-item">
                        <div class="timeline-icon chat">üí¨</div>
                        <div class="timeline-content">
                            <h4>Chat dengan AI Mentor</h4>
                            <p>{{ session.title }}</p>
                            <span class="timeline-date">{{ session.timestamp.strftime('%d %b %Y') }}</span>
                        </div>
                    </div>
                    {% endfor %}
                    {% for progress in recent_progress %}
                    <div class="timeline-item">
                        <div class="timeline-icon completed">‚úîÔ∏è</div>
                        <div class="timeline-content">
                            <h4>Menyelesaikan Materi</h4>
                            <p>{{ progress.lesson.title }}</p>
                            <span class="timeline-date">{{ progress.completed_at.strftime('%d %b %Y') }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <h4>Belum ada aktivitas</h4>
                        <p>Mulai perjalanan belajar Anda!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block page_scripts %}
    {# JavaScript untuk tombol aksi koneksi (tidak berubah) #}
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const actionWrapper = document.querySelector('.action-buttons-wrapper');

        if(actionWrapper){
            actionWrapper.addEventListener('click', async (e) => {
                const button = e.target.closest('button.action-btn');
                if (!button) return;

                const userId = button.dataset.userId;
                const action = button.dataset.action;
                const requestId = button.dataset.requestId;

                let url = '';
                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                };

                switch (action) {
                    case 'send-request':
                        url = `/api/connect/request/${userId}`;
                        break;
                    case 'cancel-request':
                        url = `/api/connect/cancel/${userId}`;
                        break;
                    case 'accept-request':
                        url = `/api/connect/accept/${requestId}`;
                        break;
                    case 'reject-request':
                        url = `/api/connect/reject/${requestId}`;
                        break;
                    case 'remove-connection':
                        url = `/api/connect/remove/${userId}`;
                        break;
                    default:
                        return;
                }

                button.disabled = true;
                button.textContent = 'Memproses...';

                try {
                    const response = await fetch(url, options);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Terjadi kesalahan.');
                    // Muat ulang halaman untuk melihat perubahan status koneksi
                    window.location.reload(); 
                } catch (error) {
                    alert(`Error: ${error.message}`);
                    window.location.reload();
                }
            });
        }
    });
    </script>
{% endblock %}