{% extends "base.html" %}

{% block content %}
<div class="hub-container-v2">
    <div class="calendar-main-panel card">
        <div id="calendar"></div>
    </div>

    <div class="details-sidebar-panel card">
        <div class="sidebar-header">
            <h3>Agenda Hari Ini</h3>
            <span id="sidebar-date-today" class="text-secondary"></span>
        </div>
        <div class="sidebar-content">
            <div id="sidebar-events" class="sidebar-section">
                <h4>Acara</h4>
                <ul class="item-list"></ul>
            </div>
            <div id="sidebar-tasks" class="sidebar-section">
                <h4>Tugas dengan Tenggat Waktu</h4>
                <ul class="item-list"></ul>
            </div>
        </div>
    </div>
</div>

<div id="eventModal" class="modal-overlay">
    <div class="modal-box card">
        <h3 id="eventModalTitle">Acara Baru</h3>
        <form id="eventForm">
            <input type="hidden" id="eventId">
            
            <div class="form-field">
                <span class="field-icon">‚úèÔ∏è</span>
                <input type="text" id="eventTitle" placeholder="Tambahkan judul acara" required>
            </div>
            <hr class="modal-divider">
            <div class="form-field">
                <span class="field-icon">‚è∞</span>
                <div class="datetime-group">
                    <input type="text" id="eventStartDate" class="flatpickr-date" placeholder="Tanggal Mulai" required>
                    <input type="text" id="eventStartTime" class="flatpickr-time" placeholder="Jam Mulai">
                    <span>-</span>
                    <input type="text" id="eventEndTime" class="flatpickr-time" placeholder="Jam Selesai">
                    <input type="text" id="eventEndDate" class="flatpickr-date" placeholder="Tanggal Selesai">
                </div>
            </div>
            <div class="form-field">
                <span class="field-icon">üìã</span>
                <textarea id="eventDescription" placeholder="Tambahkan deskripsi..."></textarea>
            </div>
            <div class="form-field">
                <span class="field-icon">üîó</span>
                <input type="url" id="eventLink" placeholder="Tambahkan link (misal: Zoom/GMeet)">
            </div>
            <div class="form-field">
                <span class="field-icon">üé®</span>
                 <div class="color-picker">
                    <div class="color-option" data-color="#5484ed" style="background: #5484ed;" title="Biru"></div>
                    <div class="color-option" data-color="#51b749" style="background: #51b749;" title="Hijau"></div>
                    <div class="color-option" data-color="#fbd75b" style="background: #fbd75b;" title="Kuning"></div>
                    <div class="color-option" data-color="#dc2127" style="background: #dc2127;" title="Merah"></div>
                    <div class="color-option" data-color="#7b17cc" style="background: #7b17cc;" title="Ungu"></div>
                </div>
                <input type="hidden" id="eventColor" value="#5484ed">
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-close-btn button-secondary">Batal</button>
                <button type="submit" class="button-primary">Simpan</button>
                <button type="button" id="eventDeleteBtn" class="button-danger" style="display: none;">Hapus</button>
            </div>
        </form>
    </div>
</div>


<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/id.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- API ENDPOINTS & Variabel Global ---
    const EVENTS_API_URL = "{{ url_for('routes.get_events') }}";
    const TASKS_API_URL = "{{ url_for('routes.get_tasks') }}";
    
    // --- Referensi Elemen DOM ---
    const calendarEl = document.getElementById('calendar');
    const sidebarDateEl = document.getElementById('sidebar-date-today');
    const sidebarEventsList = document.querySelector('#sidebar-events .item-list');
    const sidebarTasksList = document.querySelector('#sidebar-tasks .item-list');
    
    const eventModal = document.getElementById('eventModal');
    const eventForm = document.getElementById('eventForm');
    const eventModalTitle = document.getElementById('eventModalTitle');
    const eventIdInput = document.getElementById('eventId');
    const eventDeleteBtn = document.getElementById('eventDeleteBtn');
    const eventColorInput = document.getElementById('eventColor');

    // --- Inisialisasi Flatpickr ---
    const fpDateConfig = { dateFormat: "Y-m-d", locale: "id" };
    const fpTimeConfig = { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true };
    const startDatePicker = flatpickr("#eventStartDate", fpDateConfig);
    const endDatePicker = flatpickr("#eventEndDate", fpDateConfig);
    const startTimePicker = flatpickr("#eventStartTime", fpTimeConfig);
    const endTimePicker = flatpickr("#eventEndTime", fpTimeConfig);

    // --- Inisialisasi Kalender ---
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
        events: EVENTS_API_URL,
        editable: true,
        selectable: true,
        dateClick: (info) => openEventModal(null, info.date),
        eventClick: (info) => openEventModal(info.event),
        eventDrop: (info) => handleEventDrop(info.event)
    });
    calendar.render();

    // --- Event Listeners ---
    eventModal.addEventListener('click', (e) => {
        if (e.target === eventModal || e.target.classList.contains('modal-close-btn')) {
            eventModal.classList.remove('visible');
        }
    });
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            eventColorInput.value = this.dataset.color;
        });
    });
    eventForm.addEventListener('submit', handleEventFormSubmit);
    eventDeleteBtn.addEventListener('click', handleDeleteEvent);

    // --- Fungsi Logika ---
    function combineDateTime(dateStr, timeStr) {
        if (!dateStr) return null;
        return `${dateStr} ${timeStr || '00:00'}`;
    }

    function openEventModal(event, date = null) {
        eventForm.reset();
        document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));

        if (event) { // Mode Edit
            eventModalTitle.textContent = "Edit Acara";
            eventIdInput.value = event.id;
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventDescription').value = event.extendedProps.description || '';
            document.getElementById('eventLink').value = event.extendedProps.link || '';
            
            const start = new Date(event.start);
            const end = event.end ? new Date(event.end) : null;

            startDatePicker.setDate(start, true);
            startTimePicker.setDate(start, true);
            if (end) {
                endDatePicker.setDate(end, true);
                endTimePicker.setDate(end, true);
            } else {
                endDatePicker.clear();
                endTimePicker.clear();
            }

            const eventColor = event.backgroundColor || event.color || '#5484ed';
            eventColorInput.value = eventColor;
            const selectedColorEl = document.querySelector(`.color-option[data-color='${eventColor}']`);
            if(selectedColorEl) selectedColorEl.classList.add('selected');
            eventDeleteBtn.style.display = 'inline-block';
        } else { // Mode Tambah Baru
            eventModalTitle.textContent = "Acara Baru";
            eventIdInput.value = '';
            startDatePicker.setDate(date || new Date(), true);
            startTimePicker.clear();
            endDatePicker.clear();
            endTimePicker.clear();
            eventColorInput.value = '#5484ed';
            document.querySelector(".color-option[data-color='#5484ed']").classList.add('selected');
            eventDeleteBtn.style.display = 'none';
        }
        eventModal.classList.add('visible');
    }

    async function handleEventFormSubmit(e) {
        e.preventDefault();
        const eventId = eventIdInput.value;
        const eventData = {
            title: document.getElementById('eventTitle').value,
            description: document.getElementById('eventDescription').value,
            start: combineDateTime(startDatePicker.input.value, startTimePicker.input.value),
            end: combineDateTime(endDatePicker.input.value, endTimePicker.input.value),
            link: document.getElementById('eventLink').value,
            color: eventColorInput.value
        };

        const url = eventId ? `${EVENTS_API_URL}/${eventId}` : EVENTS_API_URL;
        const method = eventId ? 'PUT' : 'POST';
        try {
            const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(eventData) });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Gagal menyimpan acara');
            eventModal.classList.remove('visible');
            calendar.refetchEvents();
            loadTodaysAgenda();
        } catch (error) {
            alert(error.message);
        }
    }
    
    async function handleDeleteEvent() {
        const eventId = eventIdInput.value;
        if (eventId && confirm("Anda yakin ingin menghapus acara ini?")) {
            try {
                const response = await fetch(`${EVENTS_API_URL}/${eventId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Gagal menghapus acara');
                eventModal.classList.remove('visible');
                calendar.refetchEvents();
                loadTodaysAgenda();
            } catch (error) {
                alert(error.message);
            }
        }
    }
    
    async function handleEventDrop(info) {
        const eventData = {
            start: info.event.start.toISOString(),
            end: info.event.end ? info.event.end.toISOString() : null,
            title: info.event.title,
            description: info.event.extendedProps.description,
            link: info.event.extendedProps.link,
            color: info.event.backgroundColor
        };
        try {
            const response = await fetch(`${EVENTS_API_URL}/${info.event.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(eventData)
            });
            if (!response.ok) throw new Error('Gagal update waktu acara');
            loadTodaysAgenda(); // Update sidebar setelah drop
        } catch (error) {
            alert(error.message);
            info.revert();
        }
    }
    
    async function loadTodaysAgenda() {
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        sidebarDateEl.textContent = today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long' });

        sidebarEventsList.innerHTML = '<li class="empty-item">Memuat...</li>';
        sidebarTasksList.innerHTML = '<li class="empty-item">Memuat...</li>';
        try {
            const [eventsResponse, tasksResponse] = await Promise.all([
                fetch(`${EVENTS_API_URL}?start=${dateStr}&end=${dateStr}`),
                fetch(`${TASKS_API_URL}?date=${dateStr}`)
            ]);
            const events = await eventsResponse.json();
            const tasks = await tasksResponse.json();
            renderItems(sidebarEventsList, events, 'event');
            renderItems(sidebarTasksList, tasks, 'task');
        } catch (error) {
            console.error("Gagal memuat data agenda:", error);
            sidebarEventsList.innerHTML = '<li class="empty-item">Gagal memuat acara.</li>';
            sidebarTasksList.innerHTML = '<li class="empty-item">Gagal memuat tugas.</li>';
        }
    }

    function renderItems(listElement, items, type) {
        listElement.innerHTML = '';
        if (items.length === 0) {
            listElement.innerHTML = `<li class="empty-item">Tidak ada ${type} hari ini.</li>`;
            return;
        }
        items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'sidebar-item';
            const timeString = type === 'event' ? new Date(item.start).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '';
            li.innerHTML = `<div class="item-color-dot" style="background-color: ${item.color || '#3788d8'}"></div><div class="item-time">${timeString}</div><div class="item-title">${item.title}</div>`;
            li.addEventListener('click', () => {
                if (type === 'event') {
                    // Temukan event di kalender dan buka modal edit
                    const calEvent = calendar.getEventById(item.id);
                    if (calEvent) openEventModal(calEvent);
                }
            });
            listElement.appendChild(li);
        });
    }
    
    // Inisialisasi
    loadTodaysAgenda();
});
</script>

<style>
    /* ======================================================= */
    /* === DESAIN FINAL (v4) - TEMA GELAP & INPUT KONSISTEN === */
    /* ======================================================= */

    /* FONT & BODY */
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        background-color: #1e1e1e; 
        color: #cccccc;
    }

    /* LAYOUT UTAMA */
    .hub-container-v2 { 
        display: grid; 
        grid-template-columns: 1fr 340px;
        gap: 20px; 
        height: 88vh; 
    }
    .calendar-main-panel, .details-sidebar-panel {
        padding: 20px;
        display: flex;
        flex-direction: column;
        background-color: #252526; /* PERBAIKAN: Warna latar gelap untuk card */
        border: 1px solid #333333;
        border-radius: 8px;
    }
    #calendar {
        flex-grow: 1;
        min-height: 0;
    }

    /* SIDEBAR */
    .sidebar-header { border-bottom: 1px solid #333333; }
    .sidebar-header h3 { color: #ffffff; }
    .sidebar-section h4 { color: #888888; }
    .item-title { color: #cccccc; }
    .sidebar-item:hover { background-color: #37373d; }
    .empty-item { color: #888; }
    .item-time { color: #bbbbbb; }

    /* STYLING FULLCALENDAR (TEMA GELAP) */
    :root { --fc-border-color: #333333; --fc-today-bg-color: rgba(86, 159, 247, 0.1); }
    .fc-theme-standard { color: #cccccc; }
    .fc .fc-toolbar-title { color: #ffffff; }
    .fc .fc-button { background: #37373d !important; color: #cccccc !important; border: 1px solid #444 !important; }
    .fc .fc-button-primary:not(:disabled).fc-button-active, .fc .fc-button-primary:not(:disabled):active { background: #094771 !important; }
    .fc-day-other .fc-daygrid-day-top { color: #666; }
    .fc-col-header-cell-cushion { color: #bbbbbb; }
    .fc-daygrid-event { border: none !important; }

    /* DESAIN MODAL GELAP */
    .modal-box { background-color: #2d2d2d; color: #cccccc; max-width: 800px; max-height: 1500px;}
    .modal-box h3 { border-bottom: 1px solid #444; }
    .modal-actions { border-top: 1px solid #444; }
    .modal-box label { color: #bbbbbb; }

    /* === PERBAIKAN UTAMA: DESAIN INPUT YANG KONSISTEN & RAPI === */
    .form-field {
        display: flex;
        align-items: center; /* Membuat ikon dan input sejajar di tengah */
        gap: 16px;
        margin-bottom: 20px;
        padding: 20px 10px;
        /* Hapus border di sini, kita pindahkan ke inputnya langsung */
    }
    .form-field .field-icon {
        font-size: 20px;
        color: #888;
        width: 24px;
        text-align: center;
        flex-shrink: 0;
    }
    
    /* GAYA DASAR UNTUK SEMUA INPUT DI DALAM FORM */
    .form-field input[type="text"],
    .form-field input[type="url"],
    .form-field textarea,
    .datetime-group input.flatpickr-input {
        flex-grow: 1;
        width: 100%;
        background: transparent !important;
        border: none !important;
        border-bottom: 2px solid #555 !important;
        border-radius: 0 !important; /* Hapus radius agar lurus */
        padding: 12px 6px !important;
        font-size: 15px;
        color: #cccccc !important;
        transition: border-color 0.2s;
    }

    /* EFEK FOKUS UNTUK SEMUA INPUT */
    .form-field input[type="text"]:focus,
    .form-field input[type="url"]:focus,
    .form-field textarea:focus,
    .datetime-group input.flatpickr-input:focus {
        outline: none;
        border-bottom-color: #569ff7 !important;
    }
    
    /* PERBAIKAN: Buat area deskripsi bisa di-resize */
    .form-field textarea {
        resize: vertical;
        min-height: 60px;
    }
    
    .form-field .datetime-group {
        display: flex;
        flex-grow: 1;
        align-items: center;
        gap: 10px;
    }

    /* ======================================================= */
/* === DESAIN DARK THEME UNTUK FLATPCIKR (VERSI BARU) === */
/* ======================================================= */
.flatpickr-calendar {
    background-color: #2d2d2d;
    border: 1px solid #444;
    color: #d4d4d4;
    border-radius: 6px;
}
/* Header: Bulan, Tahun, dan Panah Navigasi */
.flatpickr-months .flatpickr-month, .flatpickr-current-month .flatpickr-monthDropdown-months {
    color: #ffffff;
    font-weight: bold;
}
.flatpickr-months .flatpickr-prev-month svg,
.flatpickr-months .flatpickr-next-month svg {
    fill: #bbbbbb;
    transition: fill 0.2s;
}
.flatpickr-months .flatpickr-prev-month:hover svg,
.flatpickr-months .flatpickr-next-month:hover svg {
    fill: #ffffff;
}
/* Nama Hari (Senin, Selasa, dst.) */
span.flatpickr-weekday {
    color: #8ab4f8; /* Warna biru muda untuk aksen */
    font-weight: 500;
}
/* Angka Tanggal */
.flatpickr-day {
    color: #d4d4d4;
    transition: background-color 0.2s, color 0.2s;
}
.flatpickr-day.today {
    border-color: #8ab4f8;
    color: #8ab4f8; /* Teks tanggal hari ini juga berwarna biru */
    font-weight: bold;
}
.flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange {
    background: #094771;
    border-color: #094771;
    color: #ffffff; /* Teks putih cerah saat dipilih */
}
.flatpickr-day:hover {
    background: #3a3d3e;
}
.flatpickr-day.disabled {
    color: #555;
}
/* Pemilih Waktu (Jam & Menit) */
.flatpickr-time {
    background-color: #2d2d2d;
    border-top: 1px solid #444;
}
.flatpickr-time .numInputWrapper:hover {
    background: #3a3d3e;
}
.numInputWrapper .numInput,
.flatpickr-time .flatpickr-time-separator, 
.flatpickr-time .flatpickr-am-pm {
    color: #d4d4d4;
}
.flatpickr-time input.flatpickr-hour, .flatpickr-time input.flatpickr-minute {
    color: #d4d4d4;
    background: transparent;
}

    /* ========================================= */
/* === PERBAIKAN: CSS UNTUK PALET WARNA === */
/* ========================================= */
.color-picker { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    padding-top: 5px; 
    flex-grow: 1;
}
.color-option { 
    width: 28px; 
    height: 28px; 
    border-radius: 50%; 
    cursor: pointer; 
    border: 3px solid transparent; 
    transition: all 0.2s; 
}
.color-option.selected { 
    border-color: #569ff7; 
    transform: scale(1.15); 
    box-shadow: 0 0 5px rgba(86,159,247,0.5); 
}

</style>
{% endblock %}
