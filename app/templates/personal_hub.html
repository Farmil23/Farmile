{% extends "base.html" %}

{% block content %}
<div class="hub-container-v2">
    <div class="calendar-main-panel hub-card">
        <div id="calendar"></div>
    </div>

    <div class="details-sidebar-panel hub-card">
        <div class="sidebar-header">
            <h3>Agenda Hari Ini</h3>
            <button id="ai-organizer-btn" class="button-secondary" title="Minta Saran AI">🚀 Minta Saran</button>
            <span id="sidebar-date-today" class="text-secondary"></span>
        </div>
        <div class="sidebar-content">
            <div id="sidebar-events" class="sidebar-section">
                <h4>Acara</h4>
                <ul class="item-list"></ul>
            </div>
            <div id="sidebar-tasks" class="sidebar-section">
                <div class="sidebar-section-header">
                    <h4>Daftar Tugas</h4>
                    <button id="add-task-btn" class="button-add" title="Tambah Tugas Baru">+</button>
                </div>
                <div id="task-categories-container"></div>
            </div>
        </div>
    </div>
</div>

<div id="eventModal" class="modal-overlay">
    <div class="modal-box hub-card">
        <div class="modal-header">
            <h3 id="eventModalTitle">Acara Baru</h3>
            <button type="button" class="modal-close-btn"></button>
        </div>
        <form id="eventForm" class="modal-form" autocomplete="off">
            <input type="hidden" id="eventId">
            <div class="form-row"><div class="field-icon">✏️</div><input type="text" id="eventTitle" class="input-box" placeholder="Tambahkan judul acara" required></div>
            <div class="datetime-stack">
                <div class="datetime-card">
                    <div class="datetime-card-header">Mulai</div>
                    <div class="form-row"><div class="field-icon">📅</div><input type="text" id="eventStartDate" class="input-box" placeholder="Tanggal Mulai" required></div>
                    <div class="form-row"><div class="field-icon">⏰</div><input type="text" id="eventStartTime" class="input-box" placeholder="Jam Mulai"></div>
                </div>
                <div class="datetime-card">
                    <div class="datetime-card-header">Selesai</div>
                    <div class="form-row"><div class="field-icon">📅</div><input type="text" id="eventEndDate" class="input-box" placeholder="Tanggal Selesai"></div>
                    <div class="form-row"><div class="field-icon">⏳</div><input type="text" id="eventEndTime" class="input-box" placeholder="Jam Selesai"></div>
                </div>
            </div>
            <div class="form-row"><div class="field-icon">📋</div><textarea id="eventDescription" class="input-box input-textarea" placeholder="Tambahkan deskripsi..."></textarea></div>
            <div class="form-row"><div class="field-icon">🔗</div><input type="url" id="eventLink" class="input-box" placeholder="Tambahkan link (misal: Zoom/GMeet)"></div>
            <div class="form-row color-row">
                <div class="field-icon">🎨</div>
                <div class="color-picker" role="radiogroup">
                    <button type="button" class="color-option" data-color="#5484ed" style="background:#5484ed" title="Biru"></button>
                    <button type="button" class="color-option" data-color="#51b749" style="background:#51b749" title="Hijau"></button>
                    <button type="button" class="color-option" data-color="#fbd75b" style="background:#fbd75b" title="Kuning"></button>
                    <button type="button" class="color-option" data-color="#dc2127" style="background:#dc2127" title="Merah"></button>
                    <button type="button" class="color-option" data-color="#7b17cc" style="background:#7b17cc" title="Ungu"></button>
                </div>
                <input type="hidden" id="eventColor" value="#5484ed">
            </div>
            <div class="modal-actions">
                <button type="button" class="button-secondary modal-close-btn">Batal</button>
                <button type="submit" class="button-primary">Simpan</button>
                <button type="button" id="eventDeleteBtn" class="button-danger" style="display:none">Hapus</button>
            </div>
        </form>
    </div>
</div>

<div id="taskModal" class="modal-overlay">
    <div class="modal-box hub-card">
        <div class="modal-header">
            <h3 id="taskModalTitle">Tugas Baru</h3>
            <button class="modal-close-btn"></button>
        </div>
        <form id="taskForm" class="modal-form">
            <input type="hidden" id="taskId">
            <div class="form-row"><div class="field-icon">✏️</div><input type="text" id="taskTitle" class="input-box" placeholder="Nama tugas..." required></div>
            <div class="form-row"><div class="field-icon">📋</div><textarea id="taskDescription" class="input-box input-textarea" placeholder="Deskripsi tugas..."></textarea></div>
            <div class="form-row"><div class="field-icon">📅</div><input type="text" id="taskDueDate" class="input-box" placeholder="Tenggat Waktu (Opsional)"></div>
            <div class="form-row"><div class="field-icon">🚩</div>
                <select id="taskPriority" class="input-box">
                    <option value="low">Prioritas Rendah</option>
                    <option value="medium" selected>Prioritas Medium</option>
                    <option value="high">Prioritas Tinggi</option>
                    <option value="urgent">Prioritas Mendesak</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="button-secondary modal-close-btn">Batal</button>
                <button type="submit" class="button-primary">Simpan Tugas</button>
                <button type="button" id="taskDeleteBtn" class="button-danger" style="display:none">Hapus</button>
            </div>
        </form>
    </div>
</div>

<div id="dailyAgendaModal" class="modal-overlay">
    <div class="modal-box hub-card" style="max-width: 500px;">
        <div class="modal-header"><h3 id="dailyAgendaTitle">Agenda</h3><button class="modal-close-btn"></button></div>
        <div id="dailyAgendaContent" class="modal-content"></div>
        <div class="modal-actions">
            <button id="addNewTaskFromDailyBtn" class="button-secondary">+ Tambah Tugas</button>
            <button id="addNewEventFromDailyBtn" class="button-primary">+ Tambah Acara</button>
        </div>
    </div>
</div>

<div id="confirmDeleteModal" class="modal-overlay">
    <div class="modal-box hub-card" style="max-width: 400px;">
        <div class="modal-header"><h3 id="confirmTitle">Konfirmasi</h3><button class="modal-close-btn"></button></div>
        <div class="modal-content"><p id="confirmMessage">Apakah Anda yakin?</p></div>
        <div class="modal-actions">
            <button id="cancelDeleteBtn" class="button-secondary modal-close-btn">Batal</button>
            <button id="confirmDeleteBtn" class="button-danger">Ya, Hapus</button>
        </div>
    </div>
</div>


<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/id.js"></script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 3.1. API ENDPOINTS & REFERENSI ELEMEN DOM ---
    const EVENTS_API_URL = "{{ url_for('routes.get_events') }}";
    const TASKS_API_URL = "{{ url_for('routes.get_tasks') }}";
    let selectedDateForNewEvent = new Date();

    const calendarEl = document.getElementById('calendar');
    const sidebarDateEl = document.getElementById('sidebar-date-today');
    const sidebarEventsList = document.querySelector('#sidebar-events .item-list');
    const sidebarTasksContainer = document.getElementById('task-categories-container');
    
    const eventModal = document.getElementById('eventModal');
    const eventForm = document.getElementById('eventForm');
    const eventModalTitle = document.getElementById('eventModalTitle');
    const eventIdInput = document.getElementById('eventId');
    const eventDeleteBtn = document.getElementById('eventDeleteBtn');
    const eventColorInput = document.getElementById('eventColor');

    const taskModal = document.getElementById('taskModal');
    const taskForm = document.getElementById('taskForm');
    const taskModalTitle = document.getElementById('taskModalTitle');
    const taskIdInput = document.getElementById('taskId');
    const taskDeleteBtn = document.getElementById('taskDeleteBtn');

    const dailyAgendaModal = document.getElementById('dailyAgendaModal');
    const confirmDeleteModal = document.getElementById('confirmDeleteModal');
    const aiOrganizerBtn = document.getElementById('ai-organizer-btn');

    // --- 3.2. INISIALISASI LIBRARY ---
    const flatpickrConfig = { locale: "id", onOpen: () => document.body.classList.add('no-scroll'), onClose: () => document.body.classList.remove('no-scroll') };
    const startDatePicker = flatpickr("#eventStartDate", { ...flatpickrConfig, dateFormat: "Y-m-d" });
    const endDatePicker = flatpickr("#eventEndDate", { ...flatpickrConfig, dateFormat: "Y-m-d" });
    const startTimePicker = flatpickr("#eventStartTime", { ...flatpickrConfig, enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true });
    const endTimePicker = flatpickr("#eventEndTime", { ...flatpickrConfig, enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true });
    const taskDueDatePicker = flatpickr("#taskDueDate", { ...flatpickrConfig, enableTime: true, dateFormat: "Y-m-d H:i" });

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        
        // --- PERUBAHAN UTAMA DI SINI ---
        headerToolbar: { 
            left: 'prev,next today', 
            center: 'title', 
            right: 'dayGridMonth,timeGridWeek,list7Days,list30Days' // Menggunakan tombol custom baru
        },
        
        views: {
            list7Days: {
                type: 'list',
                duration: { days: 7 },
                buttonText: '7 Hari Kedepan' // Nama tombol baru
            },
            list30Days: {
                type: 'list',
                duration: { days: 30 },
                buttonText: '30 Hari Kedepan' // Nama tombol baru
            }
        },
        // --- AKHIR PERUBAHAN UTAMA ---
    
        // Konfigurasi lainnya tetap sama
        events: EVENTS_API_URL,
        editable: true,
        selectable: true,
        dateClick: (info) => handleDateClick(info),
        eventClick: (info) => openEventModal(info.event),
        eventDrop: (info) => handleEventDrop(info.event),
        eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
        eventContent: (arg) => ({ html: `<div class="fc-event-main">${arg.timeText ? `<span class="fc-event-time">${arg.timeText}</span>` : ''} <span class="fc-event-title">${arg.event.title}</span></div>` })
    });
    calendar.render();

    // --- 3.3. EVENT LISTENERS ---
    document.querySelector('.fc-today-button').addEventListener('click', () => { calendar.today(); loadTodaysAgenda(); });
    document.getElementById('add-task-btn').addEventListener('click', () => openTaskModal(null));
    document.getElementById('addNewEventFromDailyBtn').addEventListener('click', () => { dailyAgendaModal.classList.remove('visible'); openEventModal(null, selectedDateForNewEvent); });
    document.getElementById('addNewTaskFromDailyBtn').addEventListener('click', () => {
        dailyAgendaModal.classList.remove('visible');
        openTaskModal(null);
        taskDueDatePicker.setDate(selectedDateForNewEvent, true);
    });
    
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal || e.target.closest('.modal-close-btn')) {
                modal.classList.remove('visible');
            }
        });
    });

    eventForm.addEventListener('submit', handleEventFormSubmit);
    taskForm.addEventListener('submit', handleTaskFormSubmit);
    eventDeleteBtn.addEventListener('click', () => { const event = { id: eventIdInput.value, title: document.getElementById('eventTitle').value }; handleDeleteEvent(event); });
    taskDeleteBtn.addEventListener('click', () => { const task = { id: taskIdInput.value, title: document.getElementById('taskTitle').value }; handleDeleteTask(task); });
    
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            eventColorInput.value = this.dataset.color;
        });
    });

    aiOrganizerBtn.addEventListener('click', handleAIOrganizerClick);

    // --- 3.4. FUNGSI LOGIKA UTAMA ---
    async function handleDateClick(clickInfo) {
        selectedDateForNewEvent = clickInfo.date;
        const dateStr = clickInfo.dateStr;
        const dailyAgendaTitle = document.getElementById('dailyAgendaTitle');
        const dailyAgendaContent = document.getElementById('dailyAgendaContent');
        
        dailyAgendaTitle.textContent = `Agenda untuk ${clickInfo.date.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' })}`;
        dailyAgendaContent.innerHTML = "<p class='empty-item'>Memuat agenda...</p>";
        dailyAgendaModal.classList.add('visible');

        try {
            const [eventsResponse, tasksResponse] = await Promise.all([
                fetch(`${EVENTS_API_URL}?start=${dateStr}&end=${dateStr}T23:59:59`),
                fetch(`${TASKS_API_URL}?date=${dateStr}`)
            ]);
            const events = await eventsResponse.json();
            const tasks = await tasksResponse.json();
            
            dailyAgendaContent.innerHTML = '';
            let eventsHtml = '<h4>Acara</h4>';
            if (events.length === 0) {
                eventsHtml += "<p class='empty-item'>Tidak ada acara terjadwal.</p>";
            } else {
                eventsHtml += '<ul class="daily-agenda-list">';
                events.forEach(event => { eventsHtml += `<li><span class="event-color-dot" style="background-color: ${event.backgroundColor || '#5484ed'}"></span> ${new Date(event.start).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })} - ${event.title}</li>`; });
                eventsHtml += '</ul>';
            }
            dailyAgendaContent.innerHTML += eventsHtml;

            let tasksHtml = '<h4 style="margin-top: 1rem;">Tugas</h4>';
            if (tasks.length === 0) {
                tasksHtml += "<p class='empty-item'>Tidak ada tugas untuk hari ini.</p>";
            } else {
                tasksHtml += '<ul class="daily-agenda-list">';
                tasks.forEach(task => { tasksHtml += `<li>✔️ ${task.title} (Prioritas: ${task.priority})</li>`; });
                tasksHtml += '</ul>';
            }
            dailyAgendaContent.innerHTML += tasksHtml;

        } catch (error) {
            console.error("Gagal memuat agenda harian:", error);
            dailyAgendaContent.innerHTML = "<p class='empty-item error'>Gagal memuat agenda.</p>";
        }
    }

    async function loadTodaysAgenda() {
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        
        sidebarDateEl.textContent = today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long' });
        sidebarEventsList.innerHTML = '<li class="empty-item">Memuat...</li>';
        sidebarTasksContainer.innerHTML = '<li class="empty-item">Memuat...</li>';

        try {
            const [eventsResponse, tasksResponse] = await Promise.all([
                fetch(`${EVENTS_API_URL}?start=${dateStr}&end=${dateStr}T23:59:59`),
                fetch(`${TASKS_API_URL}?filter=today_and_overdue`)
            ]);
            const events = await eventsResponse.json();
            const tasks = await tasksResponse.json();
            
            renderEvents(sidebarEventsList, events);
            renderCategorizedTasks(sidebarTasksContainer, tasks);
        } catch (error) {
            console.error("Gagal memuat data agenda:", error);
            sidebarEventsList.innerHTML = '<li class="empty-item error">Gagal memuat acara.</li>';
            sidebarTasksContainer.innerHTML = '<li class="empty-item error">Gagal memuat tugas.</li>';
        }
    }

    function renderEvents(listElement, events) {
        listElement.innerHTML = '';
        if (events.length === 0) {
            listElement.innerHTML = `<li class="empty-item">Tidak ada acara untuk hari ini.</li>`;
            return;
        }
        events.forEach(event => {
            const li = document.createElement('li');
            li.className = 'sidebar-item';
            const timeString = new Date(event.start).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const colorDot = `<div class="item-color-dot" style="background-color: ${event.backgroundColor || '#3788d8'}"></div>`;
            li.innerHTML = `${colorDot}<div class="item-main-content"><div class="item-header"><span class="item-title">${event.title}</span></div><p class="item-description">${timeString}</p></div>`;
            li.addEventListener('click', () => {
                const calEvent = calendar.getEventById(event.id);
                if (calEvent) openEventModal(calEvent);
            });
            listElement.appendChild(li);
        });
    }

    function renderCategorizedTasks(container, tasks) {
        container.innerHTML = '';
        const categories = {
            urgent: { title: 'Mendesak', icon: '🔥', tasks: [] },
            high: { title: 'Penting', icon: '📌', tasks: [] },
            medium: { title: 'Biasa', icon: '🗓️', tasks: [] },
            low: { title: 'Santai', icon: '☕', tasks: [] },
        };

        tasks.forEach(task => {
            const priority = task.priority || 'medium';
            if (categories[priority]) {
                categories[priority].tasks.push(task);
            }
        });

        let hasTasks = false;
        for (const key in categories) {
            const category = categories[key];
            if (category.tasks.length > 0) {
                hasTasks = true;
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'task-category';
                let tasksHtml = `<div class="task-category-header"><span class="icon">${category.icon}</span> ${category.title}</div><ul class="item-list">`;
                
                category.tasks.forEach(task => {
                    const dueDateString = task.due_date ? `Jatuh tempo: ${new Date(task.due_date).toLocaleDateString('id-ID')}` : 'Tanpa batas waktu';
                    tasksHtml += `
                        <li class="sidebar-item item-priority-${task.priority}" data-task-id="${task.id}">
                            <div class="item-main-content">
                                <div class="item-header"><span class="item-title">${task.title}</span></div>
                                <p class="item-description">${dueDateString}</p>
                            </div>
                        </li>
                    `;
                });
                tasksHtml += `</ul>`;
                categoryDiv.innerHTML = tasksHtml;
                container.appendChild(categoryDiv);

                categoryDiv.querySelectorAll('.sidebar-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const taskId = item.dataset.taskId;
                        const taskData = tasks.find(t => t.id == taskId);
                        if(taskData) openTaskModal(taskData);
                    });
                });
            }
        }
        
        if (!hasTasks) {
            container.innerHTML = `<p class="empty-item">Tidak ada tugas yang relevan hari ini.</p>`;
        }
    }

    function openEventModal(event, date = null) {
        eventForm.reset();
        document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
        if (event) {
            eventModalTitle.textContent = "Edit Acara";
            eventIdInput.value = event.id;
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventDescription').value = event.extendedProps.description || '';
            document.getElementById('eventLink').value = event.extendedProps.link || '';
            const start = new Date(event.start);
            const end = event.end ? new Date(event.end) : null;
            startDatePicker.setDate(start, true);
            startTimePicker.setDate(start, true);
            if (end) { endDatePicker.setDate(end, true); endTimePicker.setDate(end, true); } else { endDatePicker.clear(); endTimePicker.clear(); }
            const eventColor = event.backgroundColor || event.color || '#5484ed';
            eventColorInput.value = eventColor;
            const selectedColorEl = document.querySelector(`.color-option[data-color='${eventColor}']`);
            if (selectedColorEl) selectedColorEl.classList.add('selected');
            eventDeleteBtn.style.display = 'inline-block';
        } else {
            eventModalTitle.textContent = "Acara Baru";
            eventIdInput.value = '';
            const initialDate = date || new Date();
            startDatePicker.setDate(initialDate, true);
            startTimePicker.clear();
            endDatePicker.clear();
            endTimePicker.clear();
            eventColorInput.value = '#5484ed';
            document.querySelector(".color-option[data-color='#5484ed']").classList.add('selected');
            eventDeleteBtn.style.display = 'none';
        }
        eventModal.classList.add('visible');
    }

    async function handleEventFormSubmit(e) {
        e.preventDefault();
        const startDateStr = combineDateTime(startDatePicker.input.value, startTimePicker.input.value);
        const endDateStr = combineDateTime(endDatePicker.input.value, endTimePicker.input.value);
        if (startDateStr && endDateStr && (new Date(endDateStr) < new Date(startDateStr))) { alert('Waktu selesai tidak boleh lebih awal dari waktu mulai.'); return; }
        const eventId = eventIdInput.value;
        const eventData = { title: document.getElementById('eventTitle').value, description: document.getElementById('eventDescription').value, start: startDateStr, end: endDateStr, link: document.getElementById('eventLink').value, color: eventColorInput.value };
        const url = eventId ? `${EVENTS_API_URL}/${eventId}` : EVENTS_API_URL;
        const method = eventId ? 'PUT' : 'POST';
        try {
            const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(eventData) });
            if (!response.ok) throw new Error((await response.json()).message || 'Gagal menyimpan acara');
            eventModal.classList.remove('visible');
            calendar.refetchEvents();
            loadTodaysAgenda();
        } catch (error) { alert(error.message); }
    }
    
    async function handleDeleteEvent(event) {
        const confirmed = await showConfirmModal("Hapus Acara", `Anda yakin ingin menghapus "${event.title}"?`);
        if (event.id && confirmed) {
            try {
                const response = await fetch(`${EVENTS_API_URL}/${event.id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Gagal menghapus acara');
                eventModal.classList.remove('visible');
                calendar.refetchEvents();
                loadTodaysAgenda();
            } catch (error) { alert(error.message); }
        }
    }
    
    async function handleEventDrop(info) {
        const eventData = { start: info.event.start.toISOString(), end: info.event.end ? info.event.end.toISOString() : null };
        try {
            const response = await fetch(`${EVENTS_API_URL}/${info.event.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(eventData) });
            if (!response.ok) throw new Error('Gagal update waktu acara');
            loadTodaysAgenda();
        } catch (error) { alert(error.message); info.revert(); }
    }

    function openTaskModal(task) {
        taskForm.reset();
        if(task) {
            taskModalTitle.textContent = "Detail Tugas";
            taskIdInput.value = task.id;
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description || '';
            taskDueDatePicker.setDate(task.due_date || '', true);
            document.getElementById('taskPriority').value = task.priority || 'medium';
            taskDeleteBtn.style.display = 'inline-block';
        } else {
            taskModalTitle.textContent = "Tugas Baru";
            taskIdInput.value = '';
            taskDueDatePicker.clear();
            document.getElementById('taskPriority').value = 'medium';
            taskDeleteBtn.style.display = 'none';
        }
        taskModal.classList.add('visible');
    }

    async function handleTaskFormSubmit(e) {
        e.preventDefault();
        const taskId = taskIdInput.value;
        const taskData = { title: document.getElementById('taskTitle').value, description: document.getElementById('taskDescription').value, due_date: document.getElementById('taskDueDate').value || null, priority: document.getElementById('taskPriority').value };
        const url = taskId ? `${TASKS_API_URL}/${taskId}` : TASKS_API_URL;
        const method = taskId ? 'PUT' : 'POST';
        try {
            const response = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(taskData)});
            if (!response.ok) throw new Error((await response.json()).message || 'Gagal menyimpan tugas');
            taskModal.classList.remove('visible');
            loadTodaysAgenda();
        } catch (error) { alert(error.message); }
    }

    async function handleDeleteTask(task) {
        const confirmed = await showConfirmModal("Hapus Tugas", `Anda yakin ingin menghapus "${task.title}"?`);
        if(task.id && confirmed) {
            try {
                const response = await fetch(`${TASKS_API_URL}/${task.id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Gagal menghapus tugas');
                taskModal.classList.remove('visible');
                loadTodaysAgenda();
            } catch (error) { alert(error.message); }
        }
    }
    
    function handleAIOrganizerClick() {
        aiOrganizerBtn.disabled = true;
        aiOrganizerBtn.textContent = 'Mengarahkan...';
        const events = Array.from(sidebarEventsList.querySelectorAll('.sidebar-item .item-title')).map(el => el.textContent);
        const tasks = Array.from(document.querySelectorAll('#task-categories-container .sidebar-item .item-title')).map(el => el.textContent);
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('routes.ask_ai_from_hub') }}";
        const eventsInput = document.createElement('input');
        eventsInput.type = 'hidden';
        eventsInput.name = 'events';
        eventsInput.value = JSON.stringify(events);
        form.appendChild(eventsInput);
        const tasksInput = document.createElement('input');
        tasksInput.type = 'hidden';
        tasksInput.name = 'tasks';
        tasksInput.value = JSON.stringify(tasks);
        form.appendChild(tasksInput);
        document.body.appendChild(form);
        form.submit();
    }

    function showConfirmModal(title, message) {
        return new Promise((resolve) => {
            confirmDeleteModal.querySelector('#confirmTitle').textContent = title;
            confirmDeleteModal.querySelector('#confirmMessage').textContent = message;
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const cancelBtns = confirmDeleteModal.querySelectorAll('.modal-close-btn, #cancelDeleteBtn');
            const confirmHandler = () => { cleanup(true); };
            const cancelHandler = () => { cleanup(false); };
            const cleanup = (value) => {
                confirmDeleteModal.classList.remove('visible');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtns.forEach(btn => btn.removeEventListener('click', cancelHandler));
                resolve(value);
            };
            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtns.forEach(btn => btn.addEventListener('click', cancelHandler, { once: true }));
            confirmDeleteModal.classList.add('visible');
        });
    }

    function combineDateTime(dateStr, timeStr) {
        if (!dateStr) return null;
        return `${dateStr} ${timeStr || '00:00:00'}`;
    }
    
    // --- 3.5. INISIALISASI AWAL ---
    loadTodaysAgenda();
});
</script>


<style>
/* --- VARIABEL WARNA & DASAR --- */
:root {
    --bg-main: #1e1e1e; 
    --bg-card: #252526; 
    --bg-input: #3c3c3c;
    --bg-hover: #37373d; 
    --border-color: #3c3c3c; 
    --border-input-focus: #4a90e2;
    --text-primary: #e0e0e0; 
    --text-secondary: #9e9e9e; 
    --accent-primary: #4a90e2;
    --accent-danger: #d93025;
}
body.no-scroll { overflow: hidden; }

/* --- LAYOUT UTAMA --- */
.hub-container-v2 { 
    display: grid; 
    grid-template-columns: 1fr 340px; 
    gap: 20px; 
    height: 88vh; 
    padding: 20px; 
}
.hub-card { 
    background: var(--bg-card); 
    border: 1px solid var(--border-color); 
    border-radius: 10px; 
    padding: 18px; 
    display: flex; 
    flex-direction: column; 
    overflow: hidden;
}
#calendar { 
    flex-grow: 1; 
    min-height: 0; 
}
@media (max-width: 920px) { 
    .hub-container-v2 { grid-template-columns: 1fr; height: auto; } 
    .details-sidebar-panel { order: -1; max-height: 45vh; margin-bottom: 20px; } 
}

/* --- SIDEBAR --- */
.sidebar-header { 
    border-bottom: 1px solid var(--border-color); 
    padding-bottom: 8px; 
    margin-bottom: 12px; 
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    gap: 10px;
}
.sidebar-header h3 { margin:0; color: #fff; font-size:16px; flex-shrink: 0; }
.sidebar-content { flex-grow: 1; overflow-y: auto; }
.sidebar-section h4 { margin: 12px 0 8px; color: var(--text-secondary); font-size:13px; letter-spacing:0.6px; text-transform:uppercase; }
.sidebar-section-header { display: flex; justify-content: space-between; align-items: center; }
.button-add { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.button-add:hover { background-color: var(--bg-hover); color: var(--text-primary); }
.item-list { list-style:none; margin:0; padding:0; }
.sidebar-item { display:flex; gap:12px; align-items:flex-start; padding:10px; border-radius:8px; transition: background .12s ease; cursor:pointer; border-left: 3px solid transparent; }
.sidebar-item:hover { background: var(--bg-hover); }
.item-color-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; margin-top:6px; }
.item-main-content { min-width:0; flex:1; }
.item-header { display:flex; align-items:center; gap:8px; }
.item-title { font-weight:500; color: var(--text-primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.item-description { font-size: 13px; color: var(--text-secondary); margin: 4px 0 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.empty-item { color: var(--text-secondary); padding: 10px; font-style: italic; }
.empty-item.error { color: var(--accent-danger); }

/* CSS BARU UNTUK KATEGORI TUGAS */
.task-category { margin-top: 15px; }
.task-category-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-primary); font-size: 14px; font-weight: 500; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
.task-category-header .icon { font-size: 16px; }
.item-priority-urgent .item-title { color: #dc2127; }
.item-priority-high .item-title { color: #fbd75b; }

/* --- FULLCALENDAR STYLING --- */
:root { --fc-border-color: var(--border-color); --fc-today-bg-color: rgba(74, 144, 226, 0.15); }
.fc .fc-toolbar-title { color:#fff; font-size:1.4rem; }
.fc .fc-button { background:#2f3338 !important; color:#dfe8f3 !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
.fc .fc-button:hover { filter:brightness(1.2); }
.fc .fc-button-primary:not(:disabled).fc-button-active { background: var(--accent-primary) !important; color:#fff !important; }
.fc-daygrid-event { border: none !important; }
.fc-event-main { display: flex; align-items: center; gap: 5px; }
.fc-list { background-color: var(--bg-card); border: 1px solid var(--border-color) !important; }
.fc .fc-list-day-cushion { background-color: var(--bg-hover); }
.fc-daygrid-day-number, .fc-col-header-cell-cushion { color: var(--text-secondary); }

/* --- MODAL STYLING --- */
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:3000; padding:20px; }
.modal-overlay.visible { display:flex; animation: fadeIn 0.2s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal-box { width:100%; max-width:580px; background:var(--bg-card); border-radius:12px; overflow:hidden; box-shadow:0 12px 40px rgba(0,0,0,0.6); border:1px solid var(--border-color); padding: 0; }
.modal-header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:#333338; border-bottom:1px solid var(--border-color); }
.modal-header h3 { margin:0; font-size:16px; color:#fff; }
.modal-close-btn { width: 30px; height: 30px; position: relative; background: none; border: none; cursor: pointer; opacity: 0.7; transition: all 0.2s; border-radius: 50%; }
.modal-close-btn:hover { opacity: 1; background-color: var(--bg-hover); transform: rotate(90deg); }
.modal-close-btn::before, .modal-close-btn::after { content: ''; position: absolute; top: 50%; left: 50%; width: 14px; height: 2px; background-color: var(--text-secondary); }
.modal-close-btn::before { transform: translate(-50%, -50%) rotate(45deg); }
.modal-close-btn::after { transform: translate(-50%, -50%) rotate(-45deg); }
.modal-content { padding: 18px 20px 22px; }
.modal-form { padding:18px 20px 22px; display:flex; flex-direction:column; gap:12px; }
.form-row { display:flex; gap:12px; align-items:center; width:100%; }
.field-icon { width:40px; height:40px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.02); border-radius:8px; color:var(--text-secondary); font-size:18px; flex-shrink:0; border:1px solid var(--border-color); }
.input-box { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #444; background:var(--bg-main); color:var(--text-primary); font-size:14px; transition: all .16s ease; }
.input-box::placeholder { color: #8b98a8; }
.input-textarea { min-height:92px; resize:vertical; }
.input-box:focus { outline:none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.25); }
.datetime-stack { display:flex; gap:12px; }
@media (max-width:560px) { .datetime-stack { flex-direction:column; } }
.datetime-card { flex:1; background: rgba(0,0,0,0.15); border-radius:10px; padding:12px; border:1px solid var(--border-color); }
.datetime-card-header { color:var(--text-secondary); font-size:12px; margin-bottom:8px; font-weight:500; }
.flatpickr-input { width:100%; box-sizing:border-box; }
.color-row { align-items:center; }
.color-picker { display:flex; gap:8px; align-items:center; }
.color-option { width:32px; height:32px; border-radius:50%; border:2px solid transparent; cursor:pointer; transition: all .12s ease; }
.color-option:hover { transform: translateY(-2px); }
.color-option.selected { border-color: var(--accent-primary); transform: translateY(-2px) scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
.modal-actions { display:flex; justify-content:flex-end; gap:10px; padding:16px 20px; border-top:1px solid var(--border-color); margin-top:8px; }
.daily-agenda-list { list-style: none; padding: 0; margin: 0; }
.daily-agenda-list li { padding: 8px 0; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 8px; }
.daily-agenda-list li:last-child { border-bottom: none; }
#confirmDeleteModal .modal-actions { background-color: rgba(217, 48, 37, 0.1); }

/* --- TOMBOL-TOMBOL --- */
.button-primary, .button-secondary, .button-danger { border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all .2s ease; }
.button-primary { background-color: var(--accent-primary); color: white; }
.button-primary:hover { filter: brightness(1.15); }
.button-secondary { background-color: #3c3c3c; color: var(--text-primary); }
.button-secondary:hover { background-color: #4c4c4c; }
.button-danger { background-color: var(--accent-danger); color: white; }
.button-danger:hover { filter: brightness(1.15); }
</style>

{% endblock %}